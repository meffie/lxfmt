LXFMT    TITLE 'Linux disk formatter, (c) 2007/10 - Virtual Software Sy-LXF00010
               stems, Inc.'                                             LXF00020
*                                                                       LXF00030
*                                                                       LXF00040
*  Module name:                                                         LXF00050
*        LXFMT - Version 2.2                                            LXF00060
*                                                                       LXF00070
*  Function:                                                            LXF00080
*        Format a disk for use in a Linux environment                   LXF00090
*                                                                       LXF00100
*  License:                                                             LXF00110
*        This software is available at no charge under the terms        LXF00120
*        of the GNU General Public License version 3 (GPLv3) as         LXF00130
*        available from the OSI(Open Software Initiative) website.      LXF00140
*                                                                       LXF00150
*  Written by:                                                          LXF00160
*        Rick Bourgeois - Virtual Software Systems, Inc.                LXF00170
*        rick@vsoftsys.com - 770-781-3200                               LXF00180
*                                                                       LXF00190
*  Attributes:                                                          LXF00200
*        Disk resident, Non-Reentrant                                   LXF00210
*                                                                       LXF00220
*  Entry point:                                                         LXF00230
*        LXFMT                                                          LXF00240
*                                                                       LXF00250
*  Entry conditions:                                                    LXF00260
*                                                                       LXF00270
*        CMS plist pointer in register one                              LXF00280
*                                                                       LXF00290
*        DS    0F                                                       LXF00300
*PLIST   DC    CL8'LXFMT'          PROGRAM NAME                         LXF00310
*        DC    CL8'vdev'           Disk address                         LXF00320
*        DC    CL8'volser'         Optional volume serial               LXF00330
*        DC    CL8'('              Start of options                     LXF00340
*        DC    CL8'-B'             Optional BLKSIZE keyword             LXF00350
*        DC    CL8'blksize'        Block size in decimal                LXF00360
*        DC    CL8'-C'             Configuration table name             LXF00370
*        DC    CL8'config fn'      Configuration file name              LXF00380
*        DC    CL8'-F'             Format disk                          LXF00390
*        DC    CL8'-K'             Keep volume serial                   LXF00400
*        DC    CL8'-M'             Show formatted messages              LXF00410
*        DC    CL8'-N'             Create no partitions                 LXF00420
*        DC    CL8'-R'             Rewrite label & VTOC records         LXF00430
*        DC    CL8'-S'             Show Mapping                         LXF00440
*        DC    CL8'-TS'            Create a single swap partition       LXF00450
*        DC    CL8'-U'             Recreate VTOC existing P sizes       LXF00460
*        DC    CL8'-Y'             Bypass verify prompt                 LXF00470
*        DC    CL8'-P1'            Partition 1 information              LXF00480
*        DC    CL8'start track'    Starting track                       LXF00490
*        DC    CL8'end track'      Ending track                         LXF00500
*        DC    CL8'-P2'            Partition 2 information              LXF00510
*        DC    CL8'start track'    Starting track                       LXF00520
*        DC    CL8'end track'      Ending track                         LXF00530
*        DC    CL8'-P3'            Partition 3 information              LXF00540
*        DC    CL8'start track'    Starting track                       LXF00550
*        DC    CL8'end track'      Ending track                         LXF00560
*        DC    8X'FF'              FENCE                                LXF00570
*                                                                       LXF00580
*  Exit conditions:                                                     LXF00590
*                                                                       LXF00600
*        NORMAL  R15=0                                                  LXF00610
*        ERROR   R15=non zero                                           LXF00620
*                                                                       LXF00630
*  Calls to other routines:                                             LXF00640
*                                                                       LXF00650
*        CP DIAG A8                General DASD I/O                     LXF00660
*        CP DIAG 210               Virtual/Real device information      LXF00670
*                                                                       LXF00680
*  Called by:                                                           LXF00690
*        User from CMS command or exec                                  LXF00700
*                                                                       LXF00710
*  Register usage:                                                      LXF00720
*                                                                       LXF00730
*        R5    HCPSGIOP - Diag A8 plist                                 LXF00740
*        R9    VRDCBLOK - Virtual/Real device chactaristics             LXF00750
*        R10   1st Base register                                        LXF00760
*        R11   2nd Base register                                        LXF00770
*        R12   3rd Base register                                        LXF00780
*        R13   Savearea/Workarea                                        LXF00790
*                                                                       LXF00800
*  OPERATION:                                                           LXF00810
*                                                                       LXF00820
*        Verify disk is attached and R/W                                LXF00830
*        Verify request to format                                       LXF00840
*        Format all tracks                                              LXF00850
*        Write label track                                              LXF00860
*        Write VTOC track                                               LXF00870
*        Write F4 and F5/F7                                             LXF00880
*                                                                       LXF00890
         EJECT                                                          LXF00900
*------------------------------------------------------------*          LXF00910
*  Macro to front-end APPLMSG - Allows use of an external    *          LXF00920
*  message repository and providing default values           *          LXF00930
*------------------------------------------------------------*          LXF00940
         MACRO                                                          LXF00950
&LBL     LXMSG  &TEXTA=,&SUB=,&COMP=YES                                 LXF00960
&LBL     L      R15,=V(&TEXTA)                                          LXF00970
         APPLMSG TEXTA=(R15),                                          -LXF00980
               SUB=&SUB,                                               -LXF00990
               DISP=ERRMSG,                                            -LXF01000
               COMP=&COMP,                                             -LXF01010
               MF=(E,ERRMSG)                                            LXF01020
         MEND                                                           LXF01030
         EJECT                                                          LXF01040
LXFMT    START                                                          LXF01050
LXFMT    AMODE  31                                                      LXF01060
LXFMT    RMODE  ANY                                                     LXF01070
         EXTRN  LXFSE                                                   LXF01080
         PRINT  ON,NOGEN                                                LXF01090
         SPACE  1                                                       LXF01100
*------------------------------------------------------------*          LXF01110
*                      E q u a t e s . . .                   *          LXF01120
*------------------------------------------------------------*          LXF01130
         SPACE  1                                                       LXF01140
*                                                                       LXF01150
*   Message replacement flag equates                                    LXF01160
*                                                                       LXF01170
FSERFN   EQU   X'80'               Message requires filename            LXF01180
FSERFT   EQU   X'40'               Message requires filetype            LXF01190
FSERFM   EQU   X'20'               Message requires filemode            LXF01200
         SPACE 1                                                        LXF01210
*                                                                       LXF01220
*                                                                       LXF01230
*        CCW FLAG EQUATES                                               LXF01240
*                                                                       LXF01250
CD       EQU   X'80'               CHAIN DATA                           LXF01260
CC       EQU   X'40'               CHAIN COMMAND                        LXF01270
SILI     EQU   X'20'               SUPPRESS INCORRECT LENGTH            LXF01280
NO       EQU   X'10'               SUPPRESS DATA TRANSFER               LXF01290
         SPACE 1                                                        LXF01300
*===================== End of Equates =======================*          LXF01310
         EJECT                                                          LXF01320
*------------------------------------------------------------*          LXF01330
*                      D S E C T s . . .                     *          LXF01340
*------------------------------------------------------------*          LXF01350
         SPACE  1                                                       LXF01360
         PRINT OFF,NOGEN                                                LXF01370
         COPY  DEVTYPES                                                 LXF01380
         COPY  HCPCWOEQ            CCW equate values                    LXF01390
         COPY  HCPEQUAT            General equate values                LXF01400
         COPY  HCPHCCW             CCW formats                          LXF01410
         COPY  HCPSGIOP            DIAG X'A8' plist                     LXF01420
         COPY  VRDCBLOK                                                 LXF01430
         PRINT ON,NOGEN                                                 LXF01440
VRDCF1   EQU   VRDCMDFR,1                                               LXF01450
VRDCF2   EQU   VRDCNKOV,1                                               LXF01460
VRDCF3   EQU   VRDCNKOV+1,1                                             LXF01470
VRDCF4   EQU   VRDCKOVH,1                                               LXF01480
VRDCF5   EQU   VRDCKOVH+1,1                                             LXF01490
VRDCF6   EQU   VRDDEVF2+6,1                                             LXF01500
         SPACE 1                                                        LXF01510
SAVEAREA DSECT                                                          LXF01520
*                                                                       LXF01530
* The register save area must be the first area in the format           LXF01540
* work block because R13 is used as the addressing register             LXF01550
*                                                                       LXF01560
SAVEW0   DS    F                   Save word zero                       LXF01570
SAVEPREV DS    F                   Previous savearea                    LXF01580
SAVENEXT DS    F                   Next savearea                        LXF01590
SAVERE   DS    0F                  Register  E                          LXF01600
SAVER14  DS    F                   Register 14                          LXF01610
SAVERF   DS    0F                  Register  F                          LXF01620
SAVER15  DS    F                   Register 15                          LXF01630
SAVER0   DS    F                   Register  0                          LXF01640
SAVER1   DS    F                   Register  1                          LXF01650
SAVER2   DS    F                   Register  2                          LXF01660
SAVER3   DS    F                   Register  3                          LXF01670
SAVER4   DS    F                   Register  4                          LXF01680
SAVER5   DS    F                   Register  5                          LXF01690
SAVER6   DS    F                   Register  6                          LXF01700
SAVER7   DS    F                   Register  7                          LXF01710
SAVER8   DS    F                   Register  8                          LXF01720
SAVER9   DS    F                   Register  9                          LXF01730
SAVERA   DS    0F                  Register  A                          LXF01740
SAVER10  DS    F                   Register 10                          LXF01750
SAVERB   DS    0F                  Register  B                          LXF01760
SAVER11  DS    F                   Register 11                          LXF01770
SAVERC   DS    0F                  Register  C                          LXF01780
SAVER12  DS    F                   Register 12                          LXF01790
SAVEWRK0 DS    F                   Callees work areas                   LXF01800
SAVEWRK1 DS    F                   ....                                 LXF01810
SAVEWRK2 DS    F                   ....                                 LXF01820
SAVEWRK3 DS    F                   ....                                 LXF01830
SAVEWRK4 DS    F                   ....                                 LXF01840
SAVEWRK5 DS    F                   ....                                 LXF01850
SAVEWRK6 DS    F                   ....                                 LXF01860
SAVEWRK7 DS    F                   ....                                 LXF01870
SAVEWRK8 DS    F                   ....                                 LXF01880
SAVEWRK9 DS    F                   ....                                 LXF01890
*                                                                       LXF01900
* End of save area                                                      LXF01910
*                                                                       LXF01920
VSVRDCB  DS    (VRDCSIZE)D         Virtual/Real device Info             LXF01930
DWORK1   DS    D                   Double word work area                LXF01940
DWORK2   DS    D                   Double word work area                LXF01950
DWORK3   DS    D                   Double word work area                LXF01960
DBLKSZ   DS    F                   Format block size                    LXF01970
DBLTR    DS    F                   Blocks per track                     LXF01980
DTRCY    DS    F                   Tracks per cylinder                  LXF01990
DBLCY    DS    F                   Blocks per cylinder                  LXF02000
DFBADB   DS    F                   FBA blks per data block              LXF02010
DFMTCY   DS    F                   Formatted cylinders                  LXF02020
DFDFBA   DS    F                   First FBA data block                 LXF02030
DFDTRK   DS    F                   First data track                     LXF02040
DRDCB    DS    F                   Total Cyl or FBA blocks              LXF02050
DTOTBK   DS    F                   Total blocks formatted               LXF02060
DTOTR    DS    F                   Total tracks                         LXF02070
MXFBADBK DS    F                   Maximum FBA data blks                LXF02080
CNAME    DS    CL8                 Configuration name                   LXF02090
LABELTRK DS    F                   Zero                                 LXF02100
VTOCTRK  DS    F                   One                                  LXF02110
P1START  DS    F                   Partition 1 start track              LXF02120
P1END    DS    F                   Partition 1 end track                LXF02130
P2START  DS    F                   Partition 2 start track              LXF02140
P2END    DS    F                   Partition 2 end track                LXF02150
P3START  DS    F                   Partition 3 start track              LXF02160
P3END    DS    F                   Partition 3 end track                LXF02170
         SPACE 1                                                        LXF02180
SGIOPLST DS    (SGIDWSIZ)D         DIAG A8 plist                        LXF02190
*                                                                       LXF02200
*        CCWs to format tracks                                          LXF02210
*                                                                       LXF02220
FMTCCWS  DS    51D                 Maximum CCWs required                LXF02230
*                                                                       LXF02240
*        Count fields for format                                        LXF02250
*                                                                       LXF02260
R1COUNT  DS    49D                                                      LXF02270
         SPACE 1                                                        LXF02280
WORKD    DS    3D                                                       LXF02290
DIAG0SYS EQU   WORKD,8             DIAG X'00' System name               LXF02300
DIAG0ENV EQU   WORKD+8,3           DIAG X'00' Environment               LXF02310
DIAG0VER EQU   WORKD+11,1          DIAG X'00' Version code              LXF02320
DIAG0RSV EQU   WORKD+12,2          DIAG X'00' Reserved                  LXF02330
DIAG0PRC EQU   WORKD+14,2          DIAG X'00' Processor address         LXF02340
DIAG0UID EQU   WORKD+16,8          DIAG X'00' Userid                    LXF02350
         SPACE 1                                                        LXF02360
LXFMTED  DC    F'0'                                                     LXF02370
         SPACE 1                                                        LXF02380
FLAGS    DC    F'0'                PROCESSING FLAGS                     LXF02390
         SPACE 1                                                        LXF02400
FLAG1    EQU   FLAGS+0             FLAG 1                               LXF02410
BFLG     EQU   X'80'               Block size entered                   LXF02420
FFLG     EQU   X'40'               Format the disk                      LXF02430
KFLG     EQU   X'20'               Keep volume serial entered           LXF02440
MFLG     EQU   X'10'               Show periodic msgs entered           LXF02450
SFLG     EQU   X'08'               Show Mapping                         LXF02460
YFLG     EQU   X'04'               Bypass verify request                LXF02470
*        EQU   X'02'               Reserved                             LXF02480
*        EQU   X'01'               Reserved                             LXF02490
         SPACE 1                                                        LXF02500
FLAG2    EQU   FLAGS+1             FLAG 2                               LXF02510
CFLG     EQU   X'80'               Configuration name entered           LXF02520
NFLG     EQU   X'40'               Create no partitions                 LXF02530
P1FLG    EQU   X'20'               P1 info entered                      LXF02540
P2FLG    EQU   X'10'               P2 info entered                      LXF02550
P3FLG    EQU   X'08'               P3 info entered                      LXF02560
TSFLG    EQU   X'04'               Type swap entered                    LXF02570
UFLG     EQU   X'02'               Recreate VTOC existing P sizes       LXF02580
*        EQU   X'01'               Reserved                             LXF02590
         SPACE 1                                                        LXF02600
FLAG3    EQU   FLAGS+2             FLAG 3                               LXF02610
NEEDF7   EQU   X'80'               F7DSCD required for this disk        LXF02620
VOLSERF  EQU   X'40'               Volume serial entered                LXF02630
PARTERRS EQU   X'20'               Error in partitioning info           LXF02640
LBLV1    EQU   X'10'               Disk is in CDLFMT                    LXF02650
         SPACE 1                                                        LXF02660
FLAG4    EQU   FLAGS+3             FLAG 4                               LXF02670
         SPACE 1                                                        LXF02680
VDEVNUM  DS    H                                                        LXF02690
TERMBUF  DS    XL80                                                     LXF02700
BLANKS   DS    CL80                                                     LXF02710
RSTCOUNT DS    CL8                 Restart/Reformat count field         LXF02720
         SPACE 1                                                        LXF02730
HNDEXT   HNDEXT  SET,MF=L                                               LXF02740
LINERD   LINERD  MF=L                                                   LXF02750
ERRMSG   APPLMSG MF=L,MAXSUBS=6                                         LXF02760
         SPACE 1                                                        LXF02770
*                                                                       LXF02780
*        FBA buffers                                                    LXF02790
*                                                                       LXF02800
FBAIPL   DS    XL512               FBA IPL block save                   LXF02810
FBALABL  DS    XL512               FBA label block                      LXF02820
FBAVTOC1 DS    XL512               FBA VTOC block 1                     LXF02830
FBAVTOC2 DS    XL512               FBA VTOC block 1                     LXF02840
FBABLK   DS    XL512               FBA data block                       LXF02850
*                                                                       LXF02860
*        ECKD buffers                                                   LXF02870
*                                                                       LXF02880
         ORG   FBAIPL                                                   LXF02890
IPL1CNT  DS    XL8                 IPL1 count field                     LXF02900
IPL1KEY  DS    CL4                 IPL record 1 key                     LXF02910
IPL1     DS    XL24                IPL record 1                         LXF02920
*                                                                       LXF02930
*        IPL1 buffer                                                    LXF02940
*                                                                       LXF02950
IPL2CNT  DS    XL8                 IPL2 count field                     LXF02960
IPL2KEY  DS    CL4                 IPL record 2 key                     LXF02970
IPL2     DS    XL144               IPL record 2                         LXF02980
*                                                                       LXF02990
*        IPL2 buffer                                                    LXF03000
*                                                                       LXF03010
LVOL1CNT DS    XL8                 Volume label count field             LXF03020
LVOL1KEY DS    CL4                 Volume label key                     LXF03030
LVOL1    DS    XL80                Volume Label                         LXF03040
*                                                                       LXF03050
*        DSCB buffers                                                   LXF03060
*                                                                       LXF03070
F4BF1    DS    0XL148              Format 4 DSCB buffer                 LXF03080
F4BF1CT  DS    XL8                 Count field                          LXF03090
F4BF1KY  DS    XL44                Key area                             LXF03100
F4BF1DA  DS    XL96                Data area                            LXF03110
         SPACE 1                                                        LXF03120
F5BF1    DS    0XL148              Format 5 DSCB buffer                 LXF03130
F5BF1CT  DS    XL8                 Count field                          LXF03140
F5BF1KY  DS    XL44                Key area                             LXF03150
F5BF1DA  DS    XL96                Data area                            LXF03160
         SPACE 1                                                        LXF03170
F1BF1    DS    0XL148              Format 1 DSCB buffer 1               LXF03180
F1BF1CT  DS    XL8                 Count field                          LXF03190
F1BF1KY  DS    XL44                Key area                             LXF03200
F1BF1DA  DS    XL96                Data area                            LXF03210
         SPACE 1                                                        LXF03220
F1BF2    DS    0XL148              Format 1 DSCB buffer 2               LXF03230
F1BF2CT  DS    XL8                 Count field                          LXF03240
F1BF2KY  DS    XL44                Key area                             LXF03250
F1BF2DA  DS    XL96                Data area                            LXF03260
         SPACE 1                                                        LXF03270
F1BF3    DS    0XL148              Format 1 DSCB buffer 3               LXF03280
F1BF3CT  DS    XL8                 Count field                          LXF03290
F1BF3KY  DS    XL44                Key area                             LXF03300
F1BF3DA  DS    XL96                Data area                            LXF03310
         SPACE 1                                                        LXF03320
F7BF1    DS    0XL148              Format 7 DSCB buffer                 LXF03330
F7BF1CT  DS    XL8                 Count field                          LXF03340
F7BF1KY  DS    XL44                Key area                             LXF03350
F7BF1DA  DS    XL96                Data area                            LXF03360
         SPACE 1                                                        LXF03370
DSCBCNT  DS    XL8                                                      LXF03380
DSCBKEY  DS    XL44                                                     LXF03390
DSCBDATA DS    XL96                                                     LXF03400
         SPACE 1                                                        LXF03410
         ORG   ,                                                        LXF03420
         SPACE 1                                                        LXF03430
FMTWRKLN EQU   *-SAVEAREA          Length of register savearea          LXF03440
         EJECT                                                          LXF03450
         FSCBD                                                          LXF03460
         SPACE 1                                                        LXF03470
         PRINT OFF,NOGEN                                                LXF03480
F1DSCB   DSECT                                                          LXF03490
DS1DSNAM DS    CL44                Dsname                               LXF03500
DS1FMTID DS    CL1                 Format ID C'1'                       LXF03510
DS1DSSN  DS    CL6                 Serial number                        LXF03520
DS1VOLSQ DS    XL2                 Sequence number                      LXF03530
DS1CREDT DS    XL3                 Creation date                        LXF03540
DS1EXPDT DS    XL3                 Expiration date                      LXF03550
DS1NOEPV DS    XL1                 Number of extents                    LXF03560
         DS    XL1                                                      LXF03570
DS1FLAG1 DS    XL1                 Flag byte                            LXF03580
DS1SYSCD DS    CL13                System code                          LXF03590
DS1REFD  DS    XL3                 Reference date                       LXF03600
         DS    XL1                                                      LXF03610
DS1SCEXT DS    0XL3                                                     LXF03620
DS1SCXTF DS    XL1                                                      LXF03630
DS1SCXTV DS    XL2                                                      LXF03640
DS1DSORG DS    XL2                 Dataset organization                 LXF03650
DS1DSGPS EQU   X'40'               Physical sequencial                  LXF03660
DS1RECFM DS    XL1                 Record format                        LXF03670
DS1RECFF EQU   X'80'               Fixed length                         LXF03680
DS1RECFS EQU   X'08'               Standard length blocks               LXF03690
         DS    XL1                                                      LXF03700
DS1BLKL  DS    XL2                 Block length                         LXF03710
DS1LRECL DS    XL2                 Logical record length                LXF03720
         DS    XL3                                                      LXF03730
DS1DSIND DS    XL1                 Data set indicators                  LXF03740
DS1IND80 EQU   X'80'               Last data set volume                 LXF03750
DS1SCALO DS    0XL4                Secondary allocation                 LXF03760
DS1SCAL1 DS    XL1                 Space parameters                     LXF03770
DS1SCAL3 DS    XL3                 Secondary allocation                 LXF03780
         DS    XL7                                                      LXF03790
DS1EXT1  DS    0XL10               1st extent description               LXF03800
         DS    XL1                 User data block extent               LXF03810
         DS    XL1                 Extent sequence number               LXF03820
         DS    XL4                 Start CCHH                           LXF03830
         DS    XL4                 End CCHH                             LXF03840
DS1EXT2  DS    XL10                2nd extent                           LXF03850
DS1EXT3  DS    XL10                3rd extent                           LXF03860
         DS    XL5                                                      LXF03870
DS1LEN   EQU   *-F1DSCB            Length of DSCB                       LXF03880
         EJECT                                                          LXF03890
F4DSCB   DSECT                                                          LXF03900
DS4IDFMT DS    CL1                 Format ID C'4'                       LXF03910
DS4HPCHR DS    XL5                 Highest CCHHR of F1 DSCB             LXF03920
DS4DSREC DS    XL2                 Number of available DSCBs            LXF03930
         DS    XL6                                                      LXF03940
DS4VTOCI DS    XL1                 VTOC indicators                      LXF03950
DS4NOEXT DS    XL1                 Extents in VTOC                      LXF03960
         DS    XL2                                                      LXF03970
DS4DEVCT DS    0XL14               Device constants                     LXF03980
DS4DEVSZ DS    0XL4                Device size                          LXF03990
DS4DSCYL DS    XL2                 Number of cylinders                  LXF04000
DS4DSTRK DS    XL2                 Number of tracks                     LXF04010
DS4DEVTK DS    XL2                 Track length                         LXF04020
DS4DEVOV DS    0XL2                Keyed record overhead                LXF04030
DS4DEVI  DS    XL1                    Non-last keyed record overhead    LXF04040
DS4DEVL  DS    XL1                    Last keyed record overhead        LXF04050
DS4DEVK  DS    XL1                 Non-keyed record overhead            LXF04060
DS4DEVFG DS    XL1                 Flag byte                            LXF04070
DS4DSF   EQU   X'20'               Flag                                 LXF04080
DS4DEVAV EQU   X'10'               Flag                                 LXF04090
DS4DEVTL DS    XL2                 Device tolerance                     LXF04100
DS4DEVDT DS    XL1                 DSCBs per track                      LXF04110
         DS    XL25                                                     LXF04120
DS4F6PTR DS    XL5                                                      LXF04130
DS4VTOCE DS    XL10                VTOC extent description              LXF04140
         DS    XL10                                                     LXF04150
DS4EFLVL DS    CL1                 Extended FS flag byte                LXF04160
DS4EFL00 EQU   00                  Extended FS flag                     LXF04170
DS4EFL07 EQU   07                  Extended FS flag                     LXF04180
DS4EFPTR DS    CL5                 Extended FS pointer                  LXF04190
         DS    XL9                                                      LXF04200
DS4LEN   EQU   *-F4DSCB            Length of DSCB                       LXF04210
         SPACE 1                                                        LXF04220
         EJECT                                                          LXF04230
F5DSCB   DSECT                                                          LXF04240
DS5KEYID DS    XL4                 Key ID X'05050505'                   LXF04250
DS5AVEXT DS    XL5                 Available extent                     LXF04260
DS5EXTAV DS    XL35                7 extents                            LXF04270
DS5FMTID DS    CL1                 Format ID C'5'                       LXF04280
DS5MAVET DS    XL90                18 extents                           LXF04290
DS5PTRDS DS    XL5                 Forward pointer (CCHHR)              LXF04300
DS5LEN   EQU   *-F5DSCB            Length of DSCB                       LXF04310
         EJECT                                                          LXF04320
F7DSCB   DSECT                                                          LXF04330
DS7KEYID DS    XL4                 Key ID X'07070707'                   LXF04340
DS7AVEXT DS    XL40                5 F7 entries                         LXF04350
DS7FMTID DS    CL1                 Format ID C'7'                       LXF04360
DS7ADEXT DS    XL88                11 extents                           LXF04370
         DS    XL2                                                      LXF04380
DS7PTRDS DS    0XL5                Forward pointer (CCHHR)              LXF04390
DS7PTRCC DS    XL2                 Forward pointer (CC)                 LXF04400
DS7PTRHH DS    XL2                 Forward pointer (HH)                 LXF04410
DS7PTRR  DS    XL1                 Forward pointer (R)                  LXF04420
DS7LEN   EQU   *-F7DSCB            Length of DSCB                       LXF04430
         SPACE 1                                                        LXF04440
DS7EXT   DS    0XL8                F7 extent description                LXF04450
DS7RTAST DS    XL4                 Starting RTA value                   LXF04460
DS7RTAED DS    XL4                 Ending RTA value + 1                 LXF04470
         SPACE 1                                                        LXF04480
         PRINT ON,NOGEN                                                 LXF04490
*===================== End of DSECTs ========================*          LXF04500
         EJECT                                                          LXF04510
*------------------------------------------------------------*          LXF04520
*                 M a i n l i n e . . .                      *          LXF04530
*------------------------------------------------------------*          LXF04540
         SPACE  1                                                       LXF04550
LXFMT    CSECT                                                          LXF04560
         J     BYIDENT             Skip Identifier                      LXF04570
         SPACE 1                                                        LXF04580
MODID    DC    CL5'LXFMT'                                               LXF04590
ASMDATE  DC    CL18'&SYSDATC - &SYSTIME'                                LXF04600
         DC    C'COPYRIGHT 2007 VSSI. - '                               LXF04610
         DC    C'LICENSED MATERIAL - '                                  LXF04620
         DC    C'PROGRAM PROPERTY OF '                                  LXF04630
         DC    C'VIRTUAL SOFTWARE SYSTEMS INC.'                         LXF04640
VERSION  DC    CL12'Version 2.2'                                        LXF04650
         SPACE 1                                                        LXF04660
*------------------------------------------------------------*          LXF04670
*        Initialization                                      *          LXF04680
*------------------------------------------------------------*          LXF04690
         SPACE 1                                                        LXF04700
BYIDENT  DS    0H                                                       LXF04710
         STM   R14,R12,12(R13)     Save callers registers               LXF04720
         USING LXFMT,R10,R11,R12   Setup addressability                 LXF04730
*        -----------------------                                        LXF04740
         LR    R10,R15             Establish base register              LXF04750
         LHI   R12,4096            Base register extent                 LXF04760
         LA    R11,0(R12,R10)      Second base register                 LXF04770
         LA    R12,0(R12,R11)      Second base register                 LXF04780
         SLR   R15,R15             Clear return register                LXF04790
         SPACE 1                                                        LXF04800
         LA    R8,8(,R1)           Tokenized plist address              LXF04810
         LR    R9,R0               Extened plist address                LXF04820
         LH    R0,=Y(FMTWRKLN)     Work area length                     LXF04830
         SPACE 1                                                        LXF04840
         CMSSTOR OBTAIN,           Get working storage                 -LXF04850
               BYTES=(R0)                                               LXF04860
         SPACE 1                                                        LXF04870
         ST    R1,8(,R13)          FMT savearea in callers              LXF04880
         LR    R14,R1              Work address in R14                  LXF04890
         LR    R15,R0              Length in R15                        LXF04900
         LHI   R0,0                Clear for workarea clear             LXF04910
         LR    R1,R0               .....                                LXF04920
         MVCL  R14,R0              Zero the workarea                    LXF04930
         L     R1,8(,R13)          Restore workarea address             LXF04940
         ST    R13,4(,R1)          Callers savearea in ours             LXF04950
         LR    R13,R1              New savearea address                 LXF04960
         USING SAVEAREA,R13                                             LXF04970
*        ------------------                                             LXF04980
         XC    SAVER15,SAVER15     Clear return code register           LXF04990
         MVI   BLANKS,C' '         Create some blanks                   LXF05000
         MVC   BLANKS+1(79),BLANKS ....                                 LXF05010
*                                                                       LXF05020
*        Say version information                                        LXF05030
*                                                                       LXF05040
         LXMSG TEXTA=LXMSG00,                                          -LXF05050
               SUB=(CHARA,(MODID,5),CHARA,(VERSION,12),                -LXF05060
               CHARA,(ASMDATE,18))                                      LXF05070
         SPACE 1                                                        LXF05080
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF05090
         SPACE 1                                                        LXF05100
*------------------------------------------------------------*          LXF05110
*        Decode Plist                                        *          LXF05120
*------------------------------------------------------------*          LXF05130
         CLI   0(R8),X'FF'         Fence?                               LXF05140
         JE    VDEVREQ             Yes, VDEV is required                LXF05150
         SPACE 1                                                        LXF05160
*------------------------------------------------------------*          LXF05170
*        Calculate MDISK address                             *          LXF05180
*------------------------------------------------------------*          LXF05190
         CLI   0(R8),C'('          Start of options?                    LXF05200
         JE    VDEVREQ             Yes, VDEV is required                LXF05210
         SPACE 1                                                        LXF05220
         LHI   R0,8                Max parameter length                 LXF05230
         LR    R1,R8               Parameter address                    LXF05240
         BRAS  R14,VSCNVTHB        Convert ebcdic hex to binary         LXF05250
         CHI   R0,4                Valid length                         LXF05260
         JH    VDEVINV             Error if not                         LXF05270
         SPACE 1                                                        LXF05280
         STCM  R1,3,VDEVNUM        Save disk address                    LXF05290
         BRAS  R14,VSCNVTBH        Convert binary to ebcdic hex         LXF05300
         STCM  R1,15,VOLSER+2      Set in volser                        LXF05310
         SPACE 1                                                        LXF05320
*------------------------------------------------------------*          LXF05330
*        Validate disk                                                  LXF05340
*------------------------------------------------------------*          LXF05350
VALDEV   DS    0H                                                       LXF05360
         SLR   R1,R1                                                    LXF05370
         ICM   R1,3,VDEVNUM        Get device number                    LXF05380
         LA    R9,VSVRDCB          Addressability for VRDCB             LXF05390
         USING VRDCBLOK,R9                                              LXF05400
*        -----------------                                              LXF05410
         LA    R2,VRDCSIZE*8       Get length of VRDCB                  LXF05420
         STH   R2,VRDCLEN          Length for 210 to return             LXF05430
         STCM  R1,3,VRDCDVNO       Store device number in blk           LXF05440
         DIAG  R9,R0,X'210'        Get device info                      LXF05450
         JNZ   DNOTATT             BR IF UNSUPPORTED                    LXF05460
         SPACE 1                                                        LXF05470
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF05480
         JE    ISDASD              Yes, process it                      LXF05490
         SPACE 1                                                        LXF05500
         CLI   VRDCVCLA,CLASDASD   DASD DEVICE ?                        LXF05510
         JNE   NOTDASD             No, unsupported class                LXF05520
         SPACE 1                                                        LXF05530
ISDASD   DS    0H                                                       LXF05540
         LA    R8,8(,R8)           Next token                           LXF05550
         CLI   0(R8),X'FF'         Fence?                               LXF05560
         JE    PROCESS             Yes, process request                 LXF05570
         SPACE 1                                                        LXF05580
         CLI   0(R8),C'('          Options?                             LXF05590
         JE    OPTIONS             Yes, check requested options         LXF05600
         SPACE 1                                                        LXF05610
         MVC   VOLSER(6),0(R8)     Save volume serial                   LXF05620
         OI    FLAG3,VOLSERF       Show volume serial entered           LXF05630
         LA    R8,8(,R8)           Incr plist pointer                   LXF05640
         CLI   0(R8),X'FF'         Fence ?                              LXF05650
         JE    PROCESS             Yes, process format                  LXF05660
         SPACE 1                                                        LXF05670
         CLI   0(R8),C'('          Options?                             LXF05680
         JNE   UNEXPECT            No, invalid parameter                LXF05690
         SPACE 1                                                        LXF05700
OPTIONS  DS    0H                                                       LXF05710
         LA    R8,8(,R8)                                                LXF05720
         CLI   0(R8),X'FF'         Fence there ?                        LXF05730
         JE    PROCESS             Yes, process format                  LXF05740
OPTIONS2 DS    0H                                                       LXF05750
         LHI   R0,8                Max parameter length                 LXF05760
         LR    R1,R8               Parameter address                    LXF05770
         BRAS  R14,VSCGETLN        Get length                           LXF05780
         CHI   R2,2                Length too short?                    LXF05790
         JL    INVOPTN             Yes, err msg and exit                LXF05800
         SPACE 1                                                        LXF05810
         AHI   R2,-1               Decr for execute                     LXF05820
CHKBLKSZ DS    0H                                                       LXF05830
         EX    R2,CLC_B            BLKSIZE option?                      LXF05840
         JNE   CHK_C               No, check next                       LXF05850
         SPACE 1                                                        LXF05860
         TM    FLAG1,BFLG          Already entered?                     LXF05870
         JO    CONFLICT            Yes, conflict                        LXF05880
         SPACE 1                                                        LXF05890
         OI    FLAG1,BFLG          Show BLKSIZE request                 LXF05900
         BRAS  R14,NXTPARM         Get next parameter                   LXF05910
         LHI   R1,4096             4096 blocks                          LXF05920
         CLC   0(3,R8),=C'4K '     4K entered?                          LXF05930
         JE    SETBKSZ             Yes, set it up                       LXF05940
         SPACE 1                                                        LXF05950
         LHI   R1,2048             2048 blocks                          LXF05960
         CLC   0(3,R8),=C'2K '     2K entered?                          LXF05970
         JE    SETBKSZ             Yes, set it up                       LXF05980
         SPACE 1                                                        LXF05990
         LHI   R1,1024             1024 entries                         LXF06000
         CLC   0(3,R8),=C'1K '     1K entered?                          LXF06010
         JE    SETBKSZ             Yes, set it up                       LXF06020
         SPACE 1                                                        LXF06030
         LR    R1,R8                                                    LXF06040
         LHI   R0,8                                                     LXF06050
         BRAS  R14,VSCNVTDB        Convert blksize to binary            LXF06060
         JNZ   NOSUBPRM            Invalid data                         LXF06070
         SPACE 1                                                        LXF06080
SETBKSZ  DS    0H                                                       LXF06090
         ST    R1,DBLKSZ           Set block size                       LXF06100
         J     NXTOPT              Look for more optios                 LXF06110
         SPACE 1                                                        LXF06120
CHK_C    DS    0H                                                       LXF06130
         EX    R2,CLC_C            Partition config fname?              LXF06140
         JNE   CHK_F               No, Check next                       LXF06150
         SPACE 1                                                        LXF06160
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF06170
         JE    INVFBA              Yes, invalid oprion                  LXF06180
         SPACE 1                                                        LXF06190
         TM    FLAG2,CFLG+NFLG+P1FLG+P2FLG+P3FLG+TSFLG+UFLG Conflict?   LXF06200
         JNZ   CONFLICT            Yes, Issue conflict message          LXF06210
         SPACE 1                                                        LXF06220
         OI    FLAG2,CFLG          Set flag for periodic msgs           LXF06230
         BRAS  R14,NXTPARM         Get next parameter                   LXF06240
         LA    R15,CFGFILE         Set CFGFILE fname                    LXF06250
         USING FSCBD,R15                                                LXF06260
*        ---------------                                                LXF06270
         MVC   FSCBFN(8),0(R8)     Set file name                        LXF06280
         LA    R8,8(,R8)           Get next parameter                   LXF06290
         CLI   0(R8),X'FF'         Fence there?                         LXF06300
         JE    PROCESS             Yes, done with options               LXF06310
         SPACE 1                                                        LXF06320
         CLI   0(R8),C'-'          Option keywork?                      LXF06330
         JE    OPTIONS2            Yes, process next option             LXF06340
         SPACE 1                                                        LXF06350
         MVC   FSCBFT(8),0(R8)     Set file type                        LXF06360
         LA    R8,8(,R8)            Get next parameter                  LXF06370
         CLI   0(R8),X'FF'         Fence there?                         LXF06380
         JE    PROCESS             Yes, done with options               LXF06390
         SPACE 1                                                        LXF06400
         CLI   0(R8),C'-'          Option keywork?                      LXF06410
         JE    OPTIONS2            Yes, process next option             LXF06420
         SPACE 1                                                        LXF06430
         MVC   FSCBFM(2),0(R8)     Set file mode                        LXF06440
         J     NXTOPT              Look for more optios                 LXF06450
         DROP  R15                                                      LXF06460
*        ---------                                                      LXF06470
         SPACE 1                                                        LXF06480
CHK_F    DS    0H                                                       LXF06490
         EX    R2,CLC_F            Format the disk                      LXF06500
         JNE   CHK_K               No, Check next                       LXF06510
         SPACE 1                                                        LXF06520
         TM    FLAG1,FFLG          Already requested?                   LXF06530
         JO    CONFLICT            Yes, entered twice                   LXF06540
         SPACE 1                                                        LXF06550
         OI    FLAG1,FFLG          Set flag                             LXF06560
         J     NXTOPT              Look for more optios                 LXF06570
         SPACE 1                                                        LXF06580
CHK_K    DS    0H                                                       LXF06590
         EX    R2,CLC_K            Partition config fname?              LXF06600
         JNE   CHK_M               No, Check next                       LXF06610
         SPACE 1                                                        LXF06620
         TM    FLAG3,VOLSERF       Volune serial entered?               LXF06630
         JO    CONFLICT            -K conflicts                         LXF06640
         SPACE 1                                                        LXF06650
         TM    FLAG1,KFLG          Already requested?                   LXF06660
         JO    CONFLICT            Yes, entered twice                   LXF06670
         SPACE 1                                                        LXF06680
         OI    FLAG1,KFLG          Set flag                             LXF06690
         J     NXTOPT              Look for more optios                 LXF06700
         SPACE 1                                                        LXF06710
CHK_M    DS    0H                                                       LXF06720
         EX    R2,CLC_M            SHOWMSGS option?                     LXF06730
         JNE   CHK_N               No, Check next                       LXF06740
         SPACE 1                                                        LXF06750
         TM    FLAG1,MFLG          Already requested?                   LXF06760
         JO    CONFLICT            Yes, entered twice                   LXF06770
         SPACE 1                                                        LXF06780
         OI    FLAG1,MFLG          Set flag                             LXF06790
         J     NXTOPT              Look for more optios                 LXF06800
         SPACE 1                                                        LXF06810
CHK_N    DS    0H                                                       LXF06820
         EX    R2,CLC_N            No partitions option?                LXF06830
         JNE   CHK_P1              No, Check next                       LXF06840
         SPACE 1                                                        LXF06850
         TM    FLAG2,CFLG+NFLG+P1FLG+P2FLG+P3FLG+TSFLG+UFLG Conflict?   LXF06860
         JNZ   CONFLICT            Yes, Issue conflict message          LXF06870
         SPACE 1                                                        LXF06880
         OI    FLAG2,NFLG          Set flag                             LXF06890
         J     NXTOPT              Look for more optios                 LXF06900
         SPACE 1                                                        LXF06910
CHK_P1   DS    0H                                                       LXF06920
         EX    R2,CLC_P1           Partition 1 range?                   LXF06930
         JNE   CHK_P2              No, Check next                       LXF06940
         SPACE 1                                                        LXF06950
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF06960
         JE    INVFBA              Yes, invalid oprion                  LXF06970
         SPACE 1                                                        LXF06980
         TM    FLAG2,CFLG+NFLG+P1FLG+TSFLG+UFLG Conflict?               LXF06990
         JNZ   CONFLICT            Yes, Issue conflict message          LXF07000
         SPACE 1                                                        LXF07010
         OI    FLAG2,P1FLG         Set flag                             LXF07020
         LA    R3,P1START          Addr for start/END track             LXF07030
         BRAS  R7,STRTEND                                               LXF07040
         J     NXTOPT              Look for more optios                 LXF07050
         SPACE 1                                                        LXF07060
CHK_P2   DS    0H                                                       LXF07070
         EX    R2,CLC_P2           Partition 2 range?                   LXF07080
         JNE   CHK_P3              No, Check next                       LXF07090
         SPACE 1                                                        LXF07100
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF07110
         JE    INVFBA              Yes, invalid oprion                  LXF07120
         SPACE 1                                                        LXF07130
         TM    FLAG2,P1FLG         P1 specified?                        LXF07140
         JNO   PMISSING            No, error                            LXF07150
         SPACE 1                                                        LXF07160
         TM    FLAG2,CFLG+NFLG+P2FLG+P3FLG+TSFLG+UFLG Any conflict?     LXF07170
         JNZ   CONFLICT            Yes, Issue conflict message          LXF07180
         SPACE 1                                                        LXF07190
         OI    FLAG2,P2FLG         Set flag                             LXF07200
         LA    R3,P2START          Addr for start/END track             LXF07210
         BRAS  R7,STRTEND                                               LXF07220
         J     NXTOPT              Look for more optios                 LXF07230
         SPACE 1                                                        LXF07240
CHK_P3   DS    0H                                                       LXF07250
         EX    R2,CLC_P3           Partition 3 range?                   LXF07260
         JNE   CHK_S               No, Check next                       LXF07270
         SPACE 1                                                        LXF07280
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF07290
         JE    INVFBA              Yes, invalid oprion                  LXF07300
         SPACE 1                                                        LXF07310
         TM    FLAG2,P1FLG+P2FLG   P1 & P2 specified?                   LXF07320
         JNO   PMISSING            No, error                            LXF07330
         SPACE 1                                                        LXF07340
         TM    FLAG2,CFLG+NFLG+P3FLG+TSFLG+UFLG Any conflict?           LXF07350
         JNZ   CONFLICT            Yes, Issue conflict message          LXF07360
         OI    FLAG2,P3FLG         Set flag                             LXF07370
         LA    R3,P3START          Addr for start/END track             LXF07380
         BRAS  R7,STRTEND                                               LXF07390
         J     NXTOPT              Look for more optios                 LXF07400
         SPACE 1                                                        LXF07410
CHK_S    DS    0H                                                       LXF07420
         EX    R2,CLC_S            Show mapping?                        LXF07430
         JNE   CHK_TS              No, Check next                       LXF07440
         SPACE 1                                                        LXF07450
         TM    FLAG2,CFLG+NFLG+P1FLG+P2FLG+P3FLG+TSFLG+UFLG Conflict?   LXF07460
         JNZ   CONFLICT            Yes, Issue conflict message          LXF07470
         SPACE 1                                                        LXF07480
         OI    FLAG1,SFLG          Set flag                             LXF07490
         J     NXTOPT              Look for more optios                 LXF07500
         SPACE 1                                                        LXF07510
CHK_TS   DS    0H                                                       LXF07520
         EX    R2,CLC_TS           Single swap partition?               LXF07530
         JNE   CHK_U               No, Check next                       LXF07540
         SPACE 1                                                        LXF07550
         TM    FLAG2,CFLG+NFLG+P1FLG+P2FLG+P3FLG+TSFLG+UFLG Conflict?   LXF07560
         JNZ   CONFLICT            Yes, Issue conflict message          LXF07570
         SPACE 1                                                        LXF07580
         OI    FLAG2,TSFLG         Set flag                             LXF07590
         MVC   LNATIVE,=C'SWAP  '  Set as swap                          LXF07600
         J     NXTOPT              Look for more optios                 LXF07610
         SPACE 1                                                        LXF07620
CHK_U    DS    0H                                                       LXF07630
         EX    R2,CLC_U            Recreate VTOC existing P sizes       LXF07640
         JNE   CHK_Y               No, Check next                       LXF07650
         SPACE 1                                                        LXF07660
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF07670
         JE    INVFBA              Yes, invalid oprion                  LXF07680
         SPACE 1                                                        LXF07690
         TM    FLAG2,CFLG+NFLG+P1FLG+P2FLG+P3FLG+TSFLG+UFLG Conflict?   LXF07700
         JNZ   CONFLICT            Yes, Issue conflict message          LXF07710
         SPACE 1                                                        LXF07720
         OI    FLAG2,UFLG          Set flag                             LXF07730
         J     NXTOPT              Look for more optios                 LXF07740
         SPACE 1                                                        LXF07750
CHK_Y    DS    0H                                                       LXF07760
         EX    R2,CLC_Y            Bypass verify message                LXF07770
         JNE   INVOPTN             No, Invalid option                   LXF07780
         SPACE 1                                                        LXF07790
         TM    FLAG1,YFLG          Already entered?                     LXF07800
         JO    CONFLICT            Yes, Conflict                        LXF07810
         SPACE 1                                                        LXF07820
         OI    FLAG1,YFLG          Set flag                             LXF07830
*        J     NXTOPT              Look for more optios                 LXF07840
         SPACE 1                                                        LXF07850
NXTOPT   DS    0H                                                       LXF07860
         J     OPTIONS             Unexpected operand                   LXF07870
         SPACE 1                                                        LXF07880
CLC_B    CLC   0(1,R8),CON_B       Excuted compare                      LXF07890
CLC_C    CLC   0(1,R8),CON_C       Executed compare                     LXF07900
CLC_F    CLC   0(1,R8),CON_F       Executed compare                     LXF07910
CLC_I    CLC   0(1,R8),CON_I       Executed compare                     LXF07920
CLC_K    CLC   0(1,R8),CON_K       Executed compare                     LXF07930
CLC_M    CLC   0(1,R8),CON_M       Executed compare                     LXF07940
CLC_N    CLC   0(1,R8),CON_N       Executed compare                     LXF07950
CLC_P1   CLC   0(1,R8),CON_P1      Executed compare                     LXF07960
CLC_P2   CLC   0(1,R8),CON_P2      Executed compare                     LXF07970
CLC_P3   CLC   0(1,R8),CON_P3      Executed compare                     LXF07980
CLC_S    CLC   0(1,R8),CON_S       Executed compare                     LXF07990
CLC_TS   CLC   0(1,R8),CON_TS      Executed compare                     LXF08000
CLC_U    CLC   0(1,R8),CON_U       Executed compare                     LXF08010
CLC_Y    CLC   0(1,R8),CON_Y       Executed compare                     LXF08020
         SPACE 1                                                        LXF08030
*======================== End of Routine ====================*          LXF08040
         EJECT                                                          LXF08050
*============================================================*          LXF08060
*                                                            *          LXF08070
* Name     - STRTEND.                                        *          LXF08080
*                                                            *          LXF08090
* Function - Get start/end values.                           *          LXF08100
*                                                            *          LXF08110
* On Entry - R7  - Link register                             *          LXF08120
*            R8  - Spoecificaition                           *          LXF08130
*                                                            *          LXF08140
* On Exit  - R1  - Value in binary.                          *          LXF08150
*                                                            *          LXF08160
*============================================================*          LXF08170
         SPACE 1                                                        LXF08180
STRTEND  DS    0H                                                       LXF08190
         BRAS  R14,NXTPARM         Get next parameter                   LXF08200
         LHI   R1,2                Default start track                  LXF08210
         CLC   0(6,R8),=C'FIRST '  Is it first?                         LXF08220
         JE    STRTEND2            Yes, Set and get end                 LXF08230
         LR    R1,R8               Set address for convert              LXF08240
         LHI   R0,8                Maximum length                       LXF08250
         BRAS  R14,VSCNVTDB        Convert decimal to binary            LXF08260
         JNZ   NOSUBPRM            Invalid decimal number               LXF08270
STRTEND2 DS    0H                                                       LXF08280
         ST    R1,0(,R3)           Starting track                       LXF08290
         BRAS  R14,NXTPARM         Get next parameter                   LXF08300
         MVC   4(4,R3),=C'LAST '   Default to last                      LXF08310
         CLC   0(5,R8),=C'LAST '   Is it last?                          LXF08320
         BER   R7                  Yes, Return                          LXF08330
         LR    R1,R8               Set address for convert              LXF08340
         LHI   R0,8                Maximum length                       LXF08350
         BRAS  R14,VSCNVTDB        Convert decimal to binary            LXF08360
         JNZ   NOSUBPRM            Invalid decimal number               LXF08370
         ST    R1,4(,R3)           Ending track                         LXF08380
         BR    R7                  Return                               LXF08390
         SPACE 1                                                        LXF08400
*======================== End of Routine ====================*          LXF08410
         EJECT                                                          LXF08420
*============================================================*          LXF08430
*                                                            *          LXF08440
* Name     - PROCESS.                                        *          LXF08450
*                                                            *          LXF08460
* Function - Main format processing.                         *          LXF08470
*                                                            *          LXF08480
*============================================================*          LXF08490
         SPACE 1                                                        LXF08500
PROCESS  DS    0H                                                       LXF08510
         EJECT                                                          LXF08520
         TM    VRDCVFLA,MDRO       Linked R/O?                          LXF08530
         JO    LINKEDRO            Yes, can't do format                 LXF08540
*                                                                       LXF08550
*        Calculate blocks per track                                     LXF08560
*                                                                       LXF08570
         ICM   R4,15,DBLKSZ        Block size entered?                  LXF08580
         JNZ   SETBSIZE            Yes, set values                      LXF08590
         LHI   R4,4096             Default to 4K                        LXF08600
         ST    R4,DBLKSZ           Set block size                       LXF08610
SETBSIZE DS    0H                                                       LXF08620
         LHI   R0,0                Clear for divide                     LXF08630
         LR    R1,R4               Requested block size                 LXF08640
         D     R0,F512             FBA blocks/Data block                LXF08650
         LTR   R0,R0               Any remainder?                       LXF08660
         JNZ   INVBSZ              Yes, invalid block size              LXF08670
         SPACE 1                                                        LXF08680
         ST    R1,DFBADB           FBA blocks per data block            LXF08690
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF08700
         JE    NOBTCALC            Yes, no blks/trk calc                LXF08710
         SPACE 1                                                        LXF08720
         CLI   VRDCMODE,X'01'      Type 1 calculation?                  LXF08730
         JNE   SETBSZT2            No, Type 2                           LXF08740
         SPACE 1                                                        LXF08750
         LHI   R1,0                Clear for insert                     LXF08760
         ICM   R1,3,VRDCNKOV       Space calc value                     LXF08770
         AR    R1,R4               Plus block size                      LXF08780
         LHI   R14,0               Clear for insert                     LXF08790
         IC    R14,VRDCF1          Space calc value                     LXF08800
         J     SETBSZ4             Calc blocks per track                LXF08810
         SPACE 1                                                        LXF08820
SETBSZT2 DS    0H                                                       LXF08830
         LHI   R15,0               Clear for insert                     LXF08840
         IC    R15,VRDCF5          Space calc value                     LXF08850
         SLL   R15,1               *2                                   LXF08860
         LHI   R1,0                Clear for insert                     LXF08870
         IC    R1,VRDCF6           Space calc value                     LXF08880
         AR    R1,R4               Plus blocksize                       LXF08890
         DR    R0,R15              INT1 value                           LXF08900
         LTR   R0,R0               Any remainder?                       LXF08910
         JZ    SETBSZ2             No, Continue                         LXF08920
         SPACE 1                                                        LXF08930
         LA    R1,1(,R1)           Increment INT1                       LXF08940
         LHI   R0,0                Clear for multiply                   LXF08950
SETBSZ2  DS    0H                                                       LXF08960
         LHI   R14,0               Clear for insert                     LXF08970
         IC    R14,VRDCF4          Space calc value                     LXF08980
         MR    R0,R14              INT1 * F4                            LXF08990
         LR    R3,R1               Save INT1                            LXF09000
         LHI   R1,0                Clear for insert                     LXF09010
         IC    R1,VRDCF2           Space calc value                     LXF09020
         IC    R14,VRDCF1          Space calc value                     LXF09030
         MR    R0,R14              INT2                                 LXF09040
         LR    R2,R1               Save INT2                            LXF09050
         LHI   R1,0                Clear for insert                     LXF09060
         IC    R1,VRDCF6           Space calc value                     LXF09070
         AR    R1,R4               Plus block size                      LXF09080
         AR    R1,R3               Plus INT1                            LXF09090
         AR    R1,R2               Plus INT2                            LXF09100
         DR    R0,R14              Space per block                      LXF09110
         LTR   R0,R0               any remainder?                       LXF09120
         JZ    SETBSZ4             No, Continue                         LXF09130
         SPACE 1                                                        LXF09140
         LA    R1,1(,R1)           Increment space                      LXF09150
         LHI   R0,0                Clear for divide                     LXF09160
SETBSZ4  DS    0H                                                       LXF09170
         LR    R2,R1               Save space per block                 LXF09180
         ICM   R1,7,VRDCTOTR       Total usable track length            LXF09190
         DR    R0,R14              Total cells                          LXF09200
         LHI   R0,0                Clear for divide                     LXF09210
         DR    R0,R2               Blocks per track                     LXF09220
         ST    R1,DBLTR            Save for processing                  LXF09230
NOBTCALC DS    0H                                                       LXF09240
*                                                                       LXF09250
*        Get diag A8 I/O parameter list                                 LXF09260
*                                                                       LXF09270
         LA    R5,SGIOPLST         Diag A8 plist address                LXF09280
         USING SGIOP,R5                                                 LXF09290
*        --------------                                                 LXF09300
         ICM   R1,3,VDEVNUM        Requested vdev                       LXF09310
         STCM  R1,3,SGIDEVNO       Save in diag plist                   LXF09320
         OI    SGIFLG,SGIFMT       Show format 1 CCWS                   LXF09330
*                                                                       LXF09340
*        Setup external ECB for messages                                LXF09350
*                                                                       LXF09360
         SPACE 1                                                        LXF09370
         HNDEXT SET,'DUMMY',                                           -LXF09380
               ECB=(MSGECB,OS),                                        -LXF09390
               CODE=41,                                                -LXF09400
               MF=(E,HNDEXT)                                            LXF09410
         SPACE 1                                                        LXF09420
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF09430
         JNE   ECKDFMT             No, do an ECKD format                LXF09440
*                                                                       LXF09450
*        Read 4 FBA blocks                                              LXF09460
*                                                                       LXF09470
FBAFMT   DS    0H                                                       LXF09480
         MVI   VSLFOP,VSLRRD       Set locate op to RD data             LXF09490
         MVI   VSDFELB+3,X'03'     Set DE last block in extent          LXF09500
         MVC   VSDFBLK,VRDCRCSZ    Addressable block size               LXF09510
         MVI   FBADCCW,X'42'       Set read CCW op code                 LXF09520
         LHI   R15,4               4 block to process                   LXF09530
         STCM  R15,3,VSLFBCT       Set in LF plist                      LXF09540
         XC    VSLFFDE,VSLFFDE     Start with block zero                LXF09550
         LHI   R15,2048            Data length                          LXF09560
         STH   R15,FBADCCW+2       Set in FBA data CCW                  LXF09570
         LA    R1,FBAIPL           First buffer address                 LXF09580
         ST    R1,FBADCCW+4        Set in CCW                           LXF09590
         LA    R15,FBADATA         FBA CCWs address                     LXF09600
         BRAS  R14,FMTIO4          Read the label block                 LXF09610
         JNZ   ERR07FBA            Msg & exit if error                  LXF09620
         SPACE 1                                                        LXF09630
         CLC   FBALABL(4),VOL1KEY   Have a VOL1?                        LXF09640
         JNE   CHKFSHOW            No, check show request               LXF09650
         SPACE 1                                                        LXF09660
         CLC   FBALABL+12(4),F2    VTOC in block 2?                     LXF09670
         JNE   CHKFSHOW            No, check show request               LXF09680
         SPACE 1                                                        LXF09690
         CLI   FBAVTOC1,X'04'      Have a format 4 DSCB?                LXF09700
         JE    SHOWFMAP            Show te disk map                     LXF09710
         SPACE 1                                                        LXF09720
CHKFSHOW DS    0H                                                       LXF09730
         TM    FLAG1,SFLG          Show mapping?                        LXF09740
         JO    NOTCDL              Yes, exit                            LXF09750
         J     NLABFBA             No volser to keep                    LXF09760
         SPACE 1                                                        LXF09770
SHOWFMAP DS    0H                                                       LXF09780
         OI    FLAG3,LBLV1         Show we have VOL1                    LXF09790
         BRAS  R14,SHOWMAPC        Show FBA diskmap                     LXF09800
         BRAS  R7,BLANKMSG         Leave a block line                   LXF09810
         TM    FLAG1,SFLG          Show mapping?                        LXF09820
         JO    EXIT                Yes, exit                            LXF09830
*                                                                       LXF09840
*        Preserve volume serial if requested                            LXF09850
*                                                                       LXF09860
         TM    FLAG1,KFLG          Keep volume serial?                  LXF09870
         JNO   NLABFBA             No, do't read block 1                LXF09880
         MVC   VOLSER(6),FBALABL+4 Move the volser                      LXF09890
NLABFBA  DS    0H                                                       LXF09900
*                                                                       LXF09910
* This section of code handles formatting an FBA DASD device            LXF09920
*                                                                       LXF09930
         MVI   FBADCCW,X'41'       Set write CCW op code                LXF09940
         MVI   VSLFOP,VSLRWD       Set locate op to wr data             LXF09950
         ICM   R1,15,VRDCBKMA      Blks under movable access            LXF09960
         ICM   R0,15,VRDCBKFA      Plus blks under fixed access         LXF09970
         AR    R1,R0               Total FBA blocks                     LXF09980
         ST    R1,DRDCB            Save total FBA blocks                LXF09990
         LR    R6,R1               Total FBA blocks                     LXF10000
         BCTR  R1,*-*              Decr for last block                  LXF10010
         ST    R1,VSDFELB          Set DE last block in extent          LXF10020
         LHI   R0,0                Clear for divide                     LXF10030
         LR    R1,R6               Total FBA blks                       LXF10040
         D     R0,DFBADB           Max data blks                        LXF10050
         ST    R1,MXFBADBK         Maximum Data blocks                  LXF10060
         MVC   VSDFBLK,VRDCRCSZ    Addressable block size               LXF10070
         MVI   VSDFMASK,VSDFWALL   Permit all writes                    LXF10080
         LR    R7,R6               Set for max blocks                   LXF10090
         TM    FLAG1,FFLG          Format requested?                    LXF10100
         JNO   DIRFBA              No, just write IPL, VOL1 and VTOC    LXF10110
*                                                                       LXF10120
*        Verify format request                                          LXF10130
*                                                                       LXF10140
         BRAS  R7,VERFMT           ASK QUESTION                         LXF10150
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF10160
         BRAS  R7,NOTIFY           Say formatting                       LXF10170
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF10180
         LHI   R7,0                First FBA block number               LXF10190
         ST    R7,VSLFFDE          Set block number                     LXF10200
         MVC   LXFMTED,F360000     Blocks before stat msg               LXF10210
         L     R4,FBMAXCLR         Max blks to clear per I/O            LXF10220
         CR    R6,R4               Full group left?                     LXF10230
         JNL   FBAFMTLP            Yes, start format                    LXF10240
         LR    R4,R6               Set for remaining                    LXF10250
FBAFMTLP DS    0H                                                       LXF10260
         STH   R4,VSLFBCT          Blocks to clear                      LXF10270
         LA    R15,FBAFCCWS        FBA format CCWs address              LXF10280
         BRAS  R14,FMTIO4          Format a group of blocks             LXF10290
         JNZ   ERR07FBA                                                 LXF10300
         AR    R7,R4               Incr blocks cleared                  LXF10310
         SR    R6,R4               Decr block remaining                 LXF10320
         JNP   DIRFBA              Done if all cleared                  LXF10330
*                                                                       LXF10340
*        Periodic or requested processing message                       LXF10350
*                                                                       LXF10360
         TM    MSGECB,X'40'        Processing message requested?        LXF10370
         JNO   FBAPRMSG            No, check periodic                   LXF10380
         LHI   R14,0               Clear for divide                     LXF10390
         LR    R15,R7              Blocks including next group          LXF10400
         SR    R15,R4              FBA blocks formated                  LXF10410
         D     R14,DFBADB          Data blocks formatted                LXF10420
         LR    R3,R15              Set messgae register                 LXF10430
         BRAS  R14,SAYBLKS         Give formatted message               LXF10440
         NI    MSGECB,255-X'40'    Reset message requested              LXF10450
         C     R7,LXFMTED          45000 blocks formatted?              LXF10460
         BRNH  FBANOMSG            No, continue                         LXF10470
         J     FBASUPMS            Update counters                      LXF10480
*                                                                       LXF10490
FBAPRMSG DS    0H                                                       LXF10500
         C     R7,LXFMTED          45000 blocks formatted?              LXF10510
         BRNH  FBANOMSG            No, continue                         LXF10520
         TM    FLAG1,MFLG          Periodic msgs wanted?                LXF10530
         JNO   FBASUPMS            No, just update counters             LXF10540
         LHI   R14,0               Clear for divide                     LXF10550
         L     R15,LXFMTED         Total FBA blocks formatted           LXF10560
         D     R14,DFBADB          Total data blocks formatted          LXF10570
         LR    R3,R15              Set messgae register                 LXF10580
         NI    MSGECB,255-X'40'                                         LXF10590
         BRAS  R14,SAYBLKS         Give formatted message               LXF10600
FBASUPMS DS    0H                                                       LXF10610
         L     R3,LXFMTED          Current number formated              LXF10620
         A     R3,F360000          Incr for next message                LXF10630
         ST    R3,LXFMTED                                               LXF10640
FBANOMSG DS    0H                                                       LXF10650
         CR    R6,R4               Full group left?                     LXF10660
         JNL   FBAFMTLP            Yes, start format                    LXF10670
         LR    R4,R6               Set for remaining                    LXF10680
         J     FBAFMTLP            Clear remaining                      LXF10690
*                                                                       LXF10700
*        Code to process ECKD disks                                     LXF10710
*                                                                       LXF10720
ECKDFMT  DS    0H                                                       LXF10730
         LH    R1,VRDCTRKC         Tracks per cylinder                  LXF10740
         ST    R1,DTRCY            ....                                 LXF10750
         MH    R1,DBLTR+2          Blocks per cylinder                  LXF10760
         ST    R1,DBLCY            ....                                 LXF10770
         LHI   R1,0                Clear for insert                     LXF10780
         ICM   R1,3,VRDCPRIM       Total usable cylinders               LXF10790
         ST    R1,DRDCB            ....                                 LXF10800
         MH    R1,DTRCY+2          Total tracks                         LXF10810
         ST    R1,DTOTR            ....                                 LXF10820
         C     R1,F65536           Do we need an F7?                    LXF10830
         JL    NOF7                No, Continue                         LXF10840
         OI    FLAG3,NEEDF7        Show we need one                     LXF10850
NOF7     DS    0H                                                       LXF10860
         TM    FLAG2,P1FLG         Any partitions                       LXF10870
         JO    NDEFP1              Yes, dont default                    LXF10880
         OI    FLAG2,P1FLG         Show we have one                     LXF10890
         LHI   R1,2                Start on track 2                     LXF10900
         ST    R1,P1START          ....                                 LXF10910
         ICM   R1,3,VRDCPRIM       Total cylinders                      LXF10920
         MH    R1,DTRCY+2          Tracks                               LXF10930
         BCTR  R1,*-*              Last track                           LXF10940
         ST    R1,P1END            Set ending track                     LXF10950
NDEFP1   DS    0H                                                       LXF10960
         TM    FLAG1,FFLG          Doing a format                       LXF10970
         JO    CHKCONFG            Yes, check for partitions            LXF10980
         SPACE 1                                                        LXF10990
         MVI   VSLROP,VSLRRD       Set locate op to RD data             LXF11000
         MVI   VSLRRC+1,X'03'      Records to process                   LXF11010
         XC    VSLRSRC(4),VSLRSRC  Cylinder 0 head 0                    LXF11020
         MVI   VSLRSRR,X'00'       Start at record zero                 LXF11030
         LA    R1,IPL1CNT          IPL1 record area                     LXF11040
         ST    R1,TRK0R1+4         Set in CCW                           LXF11050
         LA    R1,IPL2CNT          IPL2 record area                     LXF11060
         ST    R1,TRK0R2+4         Set in CCW                           LXF11070
         LA    R1,LVOL1CNT         VOL1 record area                     LXF11080
         ST    R1,TRK0R3+4         Set in CCW                           LXF11090
         LA    R15,TRK0READ        Read for track zero                  LXF11100
         BRAS  R14,FMTIO           Read IPL1, IPL2, and Label           LXF11110
         JNZ   VERCONV             I/O err ask convert                  LXF11120
         LA    R1,LVOL1            Label to verify                      LXF11130
         BRAS  R7,CHKLBL           Verify the label                     LXF11140
         TM    FLAG1,KFLG          Keep volume serial?                  LXF11150
         JNO   NKVOL               No, check for IPL                    LXF11160
         MVC   VOLSER(6),LVOL1+4   Save volume serial                   LXF11170
NKVOL    DS    0H                                                       LXF11180
         TM    FLAG3,LBLV1         VOL1 and valid VTOC ptr?             LXF11190
         JO    FMTOK               Yes, continue                        LXF11200
VERCONV  DS    0H                                                       LXF11210
         LHI   R0,0                                                     LXF11220
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF11230
         TM    FLAG1,SFLG          Doing a show map                     LXF11240
         JO    NOTCDL              Yes, Not a CDL formatted disk        LXF11250
VERCONV2 DS    0H                                                       LXF11260
         MVC   TERMBUF(4),BLANKS   Clear response area                  LXF11270
         LXMSG TEXTA=LXMSG01,                                          -LXF11280
               SUB=(DEV,(R0))                                           LXF11290
         SPACE 1                                                        LXF11300
         LXMSG TEXTA=LXMSG02                                            LXF11310
         SPACE 1                                                        LXF11320
         LA    R7,TERMBUF          Terminal read buffer                 LXF11330
         SPACE 1                                                        LXF11340
         LINERD DATA=((R7),4),     Read response                       -LXF11350
               WAIT=YES,                                               -LXF11360
               MF=(E,LINERD)                                            LXF11370
         SPACE 1                                                        LXF11380
         CLC   TERMBUF(2),=C'Q '   Quit LXFMT?                          LXF11390
         JE    ERR06               Yes, not changed and exit            LXF11400
         CLC   TERMBUF(2),=C'C '   Continue                             LXF11410
         JNE   VERCONV             No, ask again                        LXF11420
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF11430
         J     CKDNSHOW            Can't show current map               LXF11440
FMTOK    DS    0H                                                       LXF11450
         MVI   VSLRSRH+1,X'01'     Head 1                               LXF11460
         LHI   R2,0                First record                         LXF11470
         LA    R3,F4BF1            Format 4 buffer address              LXF11480
         STC   R2,VSLRSRR          Set record number                    LXF11490
         ST    R3,DSCBREAD+4       Set Buffer address                   LXF11500
         LA    R15,DSCBREAD        Read DSCB CCW address                LXF11510
         BRAS  R14,FMTIO           Read a DSCB                          LXF11520
         JNZ   ERR07               Msg & exit if error                  LXF11530
         LA    R4,F4BF1DA          Format 4 DSCB data address           LXF11540
         USING F4DSCB,R4                                                LXF11550
         LA    R2,1(,R2)           Next record number                   LXF11560
         LA    R3,F5BF1            Format 5 buffer                      LXF11570
         STC   R2,VSLRSRR          Set record number                    LXF11580
         ST    R3,DSCBREAD+4       Set Buffer address                   LXF11590
         LA    R15,DSCBREAD        Read DSCB CCW address                LXF11600
         BRAS  R14,FMTIO           Read the format 5 DSCB               LXF11610
         JNZ   ERR07               Msg & exit if error                  LXF11620
         LA    R2,1(,R2)           Next record number                   LXF11630
         CLC   DS4EFPTR(5),ZERO    Have a format 7?                     LXF11640
         JE    READF1              No, read F1 DSCBs                    LXF11650
         LHI   R1,0                Clear for insert                     LXF11660
         IC    R1,DS4EFPTR+4       F7 record number                     LXF11670
         BCTR  R1,*-*              Decr for read CKD                    LXF11680
         STC   R1,VSLRSRR          Set as search record                 LXF11690
         LA    R3,F7BF1            Format 7 buffer                      LXF11700
         ST    R3,DSCBREAD+4       Set Buffer address                   LXF11710
         LA    R15,DSCBREAD        Read DSCB CCW address                LXF11720
         BRAS  R14,FMTIO           Read the format 7 DSCB               LXF11730
         JNZ   ERR07               Msg & exit if error                  LXF11740
         CLM   R2,1,VSLRSRR        Current record F7?                   LXF11750
         JNE   READF1                                                   LXF11760
         LA    R2,1(,R2)           Next record s/b F0 or F1             LXF11770
READF1   DS    0H                                                       LXF11780
         CLC   DS4HPCHR(5),ZERO    Any F1 DSCBs?                        LXF11790
         JE    CKDSHOW             All DSCBs read                       LXF11800
         LA    R3,F1BF1            Format 1 buffer address              LXF11810
         LHI   R0,0                                                     LXF11820
         LHI   R1,0                                                     LXF11830
         IC    R1,DS4HPCHR+4       High format 1 DSCB                   LXF11840
         SR    R1,R2               Number of F1 DSCBs                   LXF11850
F1DSCBLP DS    0H                                                       LXF11860
         STC   R2,VSLRSRR          Set record number                    LXF11870
         ST    R3,DSCBREAD+4       Set Buffer address                   LXF11880
         LA    R15,DSCBREAD        Read DSCB CCW address                LXF11890
         BRAS  R14,FMTIO           Read the format 1 or 7               LXF11900
         JNZ   ERR07               Msg & exit if error                  LXF11910
         LA    R2,1(,R2)           Next record s/b F1                   LXF11920
         LA    R3,148(,R3)         Next format 1 buffer                 LXF11930
         BRCT  R1,F1DSCBLP         Yes, read next                       LXF11940
         DROP  R4                                                       LXF11950
CKDSHOW  DS    0H                                                       LXF11960
         BRAS  R14,SHOWMAPC        Show allocated and free space        LXF11970
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF11980
         TM    FLAG1,SFLG          Doing a map?                         LXF11990
         JO    EXIT                                                     LXF12000
CKDNSHOW DS    0H                                                       LXF12010
         MVI   VSLROP,VSLRRD       Set read data LR operation           LXF12020
         MVI   VSLRRC,X'01'        Processing one record                LXF12030
*                                                                       LXF12040
*        Read a count field from track 2 and last track                 LXF12050
*        and verify block size                                          LXF12060
*                                                                       LXF12070
         LHI   R1,0                Clear for insert                     LXF12080
         ICM   R1,3,VRDCPRIM       Total cylinders                      LXF12090
         LR    R4,R1               Save for message                     LXF12100
         BCTR  R1,*-*              Last cylinder number                 LXF12110
         STCM  R1,3,VSLRSRC        Set in LR plist                      LXF12120
         ICM   R1,3,VRDCTRKC       Tracks per cylinder                  LXF12130
         BCTR  R1,*-*              Last head number                     LXF12140
         STCM  R1,3,VSLRSRH        Set in LR plist                      LXF12150
         LA    R15,RSTCOUNT        Read count buffer                    LXF12160
         ST    R15,RSTCCW+4        Set in CCW address                   LXF12170
         LA    R15,RSTCCWS         Restart test ccws address            LXF12180
         BRAS  R14,FMTIO           Go have CP do I/O                    LXF12190
         JNZ   RSTERR              Disk too small                       LXF12200
         LH    R2,RSTCOUNT+6       Save block length                    LXF12210
         LHI   R1,2                Now read R1 from trk 2               LXF12220
         STCM  R1,15,VSLRSRC       ....                                 LXF12230
         LA    R15,RSTCCWS         Restart test ccws address            LXF12240
         BRAS  R14,FMTIO           Go have CP do I/O                    LXF12250
         JNZ   RSTERR              Disk too small                       LXF12260
         CLM   R2,3,RSTCOUNT+6     Block sizes the same?                LXF12270
         JNE   RSTERR2             No, they should be                   LXF12280
         C     R2,DBLKSZ           Disk match format?                   LXF12290
         JE    CHKUREQ             Yes, check use existing part.        LXF12300
         L     R3,DBLKSZ           Format block size                    LXF12310
RSTVERBK DS    0H                                                       LXF12320
         LHI   R0,0                                                     LXF12330
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF12340
         MVC   TERMBUF(4),BLANKS   Clear response area                  LXF12350
         LXMSG TEXTA=LXMSG03,                                          -LXF12360
               SUB=(DEC,((R2),5),DEV,(R0),DEC,((R3),5))                 LXF12370
         SPACE 1                                                        LXF12380
         LXMSG TEXTA=LXMSG04                                            LXF12390
         SPACE 1                                                        LXF12400
         LA    R7,TERMBUF          Terminal read buffer                 LXF12410
         SPACE 1                                                        LXF12420
         LINERD DATA=((R7),4)      Read responce                       -LXF12430
               WAIT=YES,                                               -LXF12440
               MF=(E,LINERD)                                            LXF12450
         SPACE 1                                                        LXF12460
         CLC   TERMBUF(2),=C'Q '   Quit LXFMT?                          LXF12470
         JE    ERR06               Yes, not changed and exit            LXF12480
         CLC   TERMBUF(2),=C'D '   Use disk block size?                 LXF12490
         JNE   RSTVERBK            No, ask again                        LXF12500
         ST    R2,DBLKSZ           Set disk block size                  LXF12510
CHKUREQ  DS    0H                                                       LXF12520
         TM    FLAG2,UFLG          Use existing partitions              LXF12530
         JNO   CHKCONFG            No, process normally                 LXF12540
         MVI   RSTCCW,X'06'        Read data CCW                        LXF12550
         LA    R1,DSCBDATA         Buffer address                       LXF12560
         ST    R1,RSTCCW+4                                              LXF12570
         LHI   R1,96                                                    LXF12580
         STH   R1,RSTCCW+2                                              LXF12590
         LHI   R1,1                Now read R3 from trk 1               LXF12600
         STCM  R1,15,VSLRSRC       ....                                 LXF12610
         MVI   VSLRSRR,X'03'       VTOC record 3                        LXF12620
RSTREAD  DS    0H                                                       LXF12630
         LA    R15,RSTCCWS         Restart test ccws address            LXF12640
         BRAS  R14,FMTIO           Go have CP do I/O                    LXF12650
         JNZ   RSTUERR             Disk too small                       LXF12660
         LA    R4,DSCBKEY                                               LXF12670
         USING F1DSCB,R4                                                LXF12680
         CLI   DS1FMTID,C'1'       Format 1 DSCB?                       LXF12690
         JE    DSCBP1              Yes, process it                      LXF12700
         CLI   DS1FMTID,C'7'       Format 7 DSCB?                       LXF12710
         JNE   RSTUERR             No, we have an error                 LXF12720
         LHI   R1,0                Clear for insert                     LXF12730
         IC    R1,VSLRSRR          Current record number                LXF12740
         AHI   R1,1                Next record                          LXF12750
         STC   R1,VSLRSRR          Save it                              LXF12760
         J     RSTREAD             Read next                            LXF12770
DSCBP1   DS    0H                                                       LXF12780
         ICM   R0,15,DS1EXT1+2     Start of extent                      LXF12790
         ST    R0,P1START          ....                                 LXF12800
         ICM   R0,15,DS1EXT1+6     End of extent                        LXF12810
         ST    R0,P1END            ....                                 LXF12820
         OI    FLAG2,P1FLG         Show we have 1                       LXF12830
         LHI   R1,0                Clear for insert                     LXF12840
         IC    R1,VSLRSRR          Current record number                LXF12850
         AHI   R1,1                Next record                          LXF12860
         STC   R1,VSLRSRR          Save it                              LXF12870
         LA    R15,RSTCCWS         Restart test ccws address            LXF12880
         BRAS  R14,FMTIO           Go have CP do I/O                    LXF12890
         JNZ   RSTUERR             Disk too small                       LXF12900
         CLI   DS1FMTID,C'1'       Format 1 DSCB?                       LXF12910
         JNE   CHKCONFG            No, we're done                       LXF12920
         ICM   R0,15,DS1EXT1+2     Start of extent                      LXF12930
         ST    R0,P2START          ....                                 LXF12940
         ICM   R0,15,DS1EXT1+6     End of extent                        LXF12950
         ST    R0,P2END            ....                                 LXF12960
         OI    FLAG2,P2FLG         Show we have 2                       LXF12970
         LHI   R1,0                Clear for insert                     LXF12980
         IC    R1,VSLRSRR          Current record number                LXF12990
         AHI   R1,1                Next record                          LXF13000
         STC   R1,VSLRSRR          Save it                              LXF13010
         LA    R15,RSTCCWS         Restart test ccws address            LXF13020
         BRAS  R14,FMTIO           Go have CP do I/O                    LXF13030
         JNZ   RSTUERR             Disk too small                       LXF13040
         CLI   DS1FMTID,C'1'       Format 1 DSCB?                       LXF13050
         JNE   CHKCONFG            Non we're donet                      LXF13060
         ICM   R0,15,DS1EXT1+2     Start of extent                      LXF13070
         ST    R0,P3START          ....                                 LXF13080
         ICM   R0,15,DS1EXT1+6     End of extent                        LXF13090
         ST    R0,P3END            ....                                 LXF13100
         OI    FLAG2,P3FLG         Show we have 3                       LXF13110
         DROP  R4                                                       LXF13120
*        --------                                                       LXF13130
CHKCONFG DS    0H                                                       LXF13140
*                                                                       LXF13150
*        Setup the format CCWs                                          LXF13160
*                                                                       LXF13170
         LHI   R0,8                Write for count length               LXF13180
         LA    R1,R1COUNT          Record count fields                  LXF13190
         LHI   R2,1                First record number                  LXF13200
         L     R3,DBLKSZ           Size of blocks                       LXF13210
         LA    R14,FMTCCWS         CCWs to format a track               LXF13220
         L     R15,DBLTR           Number of count fields               LXF13230
         USING HCCW,R14                                                 LXF13240
*        --------------                                                 LXF13250
SETCCWS  DS    0H                                                       LXF13260
         MVI   HCCWCMND,X'1D'      Write CKD CCW                        LXF13270
         MVI   HCCWFLAG,CCWCC+CCWSILI Chain command & SILI              LXF13280
         STH   R0,HCCWCNT          Set CCW data length                  LXF13290
         ST    R1,HCCWADDR         Set count field address              LXF13300
         STC   R2,4(,R1)           Record number in count               LXF13310
         STCM  R3,3,6(R1)          Blksize in count                     LXF13320
         AHI   R2,1                Next record number                   LXF13330
         LA    R1,8(,R1)           Next count field                     LXF13340
         LA    R14,HCCWNEXT        Next CCW                             LXF13350
         BRCT  R15,SETCCWS         Loop through CCWs                    LXF13360
         MVI   HCCWCMND,X'03'      End with a NOP                       LXF13370
         MVI   HCCWFLAG,CCWSILI    Break chain                          LXF13380
         DROP  R14                                                      LXF13390
*        ---------                                                      LXF13400
*                                                                       LXF13410
*        Setup Count fields to write additional track zero records      LXF13420
*                                                                       LXF13430
         TM    FLAG2,CFLG          Config filename entered?             LXF13440
         JNO   CFGDONE             No, continue                         LXF13450
         LA    R7,P1START          Range fields                         LXF13460
CFGLOOP  DS    0H                                                       LXF13470
         SPACE 1                                                        LXF13480
         FSOPEN FSCB=CFGFILE                                            LXF13490
         SPACE 1                                                        LXF13500
         LTR   R15,R15             Open Error?                          LXF13510
         JNZ   FSERROR             Yes... Go process                    LXF13520
         SPACE 1                                                        LXF13530
         LA    R8,TERMBUF          Buffer for read                      LXF13540
         FSREAD FSCB=CFGFILE,BUFFER=(R8)                                LXF13550
         SPACE 1                                                        LXF13560
         LTR   R15,R15                                                  LXF13570
         JZ    PROCCFG                                                  LXF13580
         SPACE 1                                                        LXF13590
         CHI   R15,12                                                   LXF13600
         JE    CFGEOF                                                   LXF13610
         J     FSERROR                                                  LXF13620
         SPACE 1                                                        LXF13630
PROCCFG  DS    0H                                                       LXF13640
         OC    TERMBUF(80),BLANKS  Make sure upper case                 LXF13650
         LHI   R0,8                Max length for 1 field               LXF13660
         LA    R1,TERMBUF          Record address                       LXF13670
         CLC   0(6,R1),=C'FIRST,'  Is it first?                         LXF13680
         JNE   CFGPSTRT            No, convert start track              LXF13690
         SPACE 1                                                        LXF13700
         LHI   R14,2               Default first track                  LXF13710
         ST    R14,0(,R7)          Set partition start                  LXF13720
         BRAS  R14,VSCGETLN        Get length of 1st parameter          LXF13730
         J     CFGPEND             Look for end                         LXF13740
         SPACE 1                                                        LXF13750
CFGPSTRT DS    0H                                                       LXF13760
         BRAS  R14,VSCNVTDB        Convert decimal to binary            LXF13770
         JNZ   CFGERR              Error if convert fails               LXF13780
         SPACE 1                                                        LXF13790
         ST    R1,0(,R7)           Set partition start                  LXF13800
CFGPEND  DS    0H                                                       LXF13810
         AR    R8,R2               Increment to end of field            LXF13820
         CLI   0(R8),C','                                               LXF13830
         JNE   CFGERR                                                   LXF13840
         SPACE 1                                                        LXF13850
         CLC   0(6,R8),=C',LAST '  Requesting last?                     LXF13860
         JNE   CFGDOEND                                                 LXF13870
         SPACE 1                                                        LXF13880
         L     R14,DTOTR           Total tracks                         LXF13890
         BCTR  R14,*-*             Base zero                            LXF13900
         ST    R14,4(,R7)          Set partition end                    LXF13910
         J     CFGEOF              Can't be any more                    LXF13920
         SPACE 1                                                        LXF13930
CFGDOEND DS    0H                                                       LXF13940
         LA    R1,1(,R8)           Addres of ending track               LXF13950
         BRAS  R14,VSCNVTDB        Convert decimal to binary            LXF13960
         JNZ   CFGERR              Error if convert fails               LXF13970
         SPACE 1                                                        LXF13980
         ST    R1,4(,R7)           Set partition end                    LXF13990
         LA    R7,8(,R7)           Next table entry                     LXF14000
         J     CFGLOOP             Read next record                     LXF14010
         SPACE 1                                                        LXF14020
CFGEOF   DS    0H                                                       LXF14030
         FSCLOSE FSCB=CFGFILE                                           LXF14040
         SPACE 1                                                        LXF14050
         LTR   R15,R15             Error closing?                       LXF14060
         JNZ   FSERROR             Yes... Go process                    LXF14070
         SPACE 1                                                        LXF14080
         ICM   R1,15,P1START       Have a P1                            LXF14090
         JZ    CFGDONE             No, were done                        LXF14100
         SPACE 1                                                        LXF14110
         OI    FLAG2,P1FLG         Show we have it                      LXF14120
         ICM   R1,15,P2START       Have a P2                            LXF14130
         JZ    CFGDONE             No, were done                        LXF14140
         SPACE 1                                                        LXF14150
         OI    FLAG2,P2FLG         Show we have it                      LXF14160
         ICM   R1,15,P3START       Have a P3                            LXF14170
         JZ    CFGDONE             No, were done                        LXF14180
         SPACE 1                                                        LXF14190
         OI    FLAG2,P3FLG         Show we have it                      LXF14200
CFGDONE  DS    0H                                                       LXF14210
         TM    FLAG2,UFLG          Extents from DSCBs                   LXF14220
         JO    PARTDONE            Yes, No conversion needed            LXF14230
         SPACE 1                                                        LXF14240
         TM    FLAG2,P1FLG         Have a partition 1?                  LXF14250
         JNO   PARTDONE            No, we're done                       LXF14260
         SPACE 1                                                        LXF14270
         MVC   VTOCTRK,F1          Set VTOC track                       LXF14280
         LA    R3,P1START          Partition to process                 LXF14290
         BRAS  R7,SETPART          Convert tracks to CCHH               LXF14300
         CLC   P1START,VTOCTRK     P1 overlap VTOC?                     LXF14310
         JH    P1OK                No, continue                         LXF14320
         SPACE 1                                                        LXF14330
         BRAS  R14,PARTOVLP        Say we have an overlap               LXF14340
P1OK     DS    0H                                                       LXF14350
         TM    FLAG2,P2FLG         Have a partition 2?                  LXF14360
         JNO   PARTDONE                                                 LXF14370
         SPACE 1                                                        LXF14380
         LA    R3,P2START          Partition to process                 LXF14390
         BRAS  R7,SETPART          Convert tracks to CCHH               LXF14400
         CLC   P1END(2),P2START    Check cylinder oveerlap              LXF14410
         JE    P2CHKH              Equal, check head                    LXF14420
         JL    P3CHK               Low is ok                            LXF14430
         J     P2ERR               High is an error                     LXF14440
         SPACE 1                                                        LXF14450
P2CHKH   DS    0H                                                       LXF14460
         CLC   P1END+2(2),P2START+2 Check head overlap                  LXF14470
         JL    P3CHK               Low is ok                            LXF14480
         SPACE 1                                                        LXF14490
P2ERR    DS    0H                                                       LXF14500
         BRAS  R14,PARTOVLP        Say we have an overlap               LXF14510
P3CHK    DS    0H                                                       LXF14520
         TM    FLAG2,P3FLG         Have a partition 3?                  LXF14530
         JNO   PARTDONE                                                 LXF14540
         SPACE 1                                                        LXF14550
         LA    R3,P3START          Partition to process                 LXF14560
         BRAS  R7,SETPART          Convert tracks to CCHH               LXF14570
         CLC   P2END(2),P3START    Check cylinder overlap               LXF14580
         JE    P3CHKH              Equal, check head                    LXF14590
         JL    PARTDONE            Low is ok                            LXF14600
         J     P3ERR               High is an error                     LXF14610
         SPACE 1                                                        LXF14620
P3CHKH   DS    0H                                                       LXF14630
         CLC   P2END+2(2),P3START+2 Check head overlap                  LXF14640
         JL    PARTDONE            Low is ok                            LXF14650
         SPACE 1                                                        LXF14660
P3ERR    DS    0H                                                       LXF14670
         BRAS  R14,PARTOVLP        Say we have an overlap               LXF14680
PARTDONE DS    0H                                                       LXF14690
         TM    FLAG3,PARTERRS      Any partioning errors?               LXF14700
         JO    ERR06               No disk changes                      LXF14710
         SPACE 1                                                        LXF14720
         MVI   VSLROP,VSLRFW       Set format write LR oper             LXF14730
         L     R1,DBLTR            BLKS/TRK                             LXF14740
         STC   R1,VSLRRC           SET IN LOCATE RECORD PLIST           LXF14750
         MVI   VSLRSRR,X'00'       Start at R0                          LXF14760
*                                                                       LXF14770
*        VERIFY FORMAT REQUEST                                          LXF14780
*                                                                       LXF14790
         TM    FLAG1,FFLG          Format request?                      LXF14800
         JO    FMTMD               Yes, do format                       LXF14810
         SPACE 1                                                        LXF14820
         L     R7,DRDCB            Size of VDEV                         LXF14830
         LHI   R8,0                full cylinders                       LXF14840
         J     DIRROUT             Go write directory records           LXF14850
         EJECT                                                          LXF14860
*                                                                       LXF14870
FMTMD    DS    0H                                                       LXF14880
*                                                                       LXF14890
*        Preseve volume serial if requested                             LXF14900
*                                                                       LXF14910
         TM    FLAG1,KFLG          Keep volume serial?                  LXF14920
         JNO   NLABCKD             No, check for IPL                    LXF14930
         SPACE 1                                                        LXF14940
         MVI   VSLROP,VSLRRD       Set locate op to RD data             LXF14950
         MVI   VSLRRC+1,X'01'      Records to process                   LXF14960
         XC    VSLRSRC(4),VSLRSRC  Cylinder 0 head 0                    LXF14970
         MVI   VSLRSRR,X'03'       Label record number                  LXF14980
         MVI   BLOKCCW,X'06'       Set read CCW op code                 LXF14990
         LHI   R15,80              Data length                          LXF15000
         STH   R15,BLOKCCW+2       Set in data CCW                      LXF15010
         LA    R15,LVOL1           Buffer address                       LXF15020
         ST    R15,BLOKCCW+4       Set in CCW                           LXF15030
         LA    R15,BLOKCCW         CKD CCW address                      LXF15040
         BRAS  R14,FMTIO           Read the lable block                 LXF15050
         JNZ   ERR07FBA            Msg & exit if error                  LXF15060
         SPACE 1                                                        LXF15070
         BRAS  R7,CHKLBL           Verify the label                     LXF15080
         MVC   VOLSER(6),LVOL1+4   Move the volser                      LXF15090
NLABCKD  DS    0H                                                       LXF15100
         BRAS  R7,VERFMT           Verify request                       LXF15110
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF15120
         BRAS  R7,NOTIFY           Say formatting                       LXF15130
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF15140
         LHI   R7,0                Clear cylinder number register       LXF15150
         LR    R8,R7               Clear head number register           LXF15160
         MVI   VSLROP,VSLRFW       Set format write LR OP               LXF15170
         MVI   VSLRSRR,X'00'       Format uses R0                       LXF15180
*                                                                       LXF15190
*        BLOCK FORMAT ROUTINE                                           LXF15200
*                                                                       LXF15210
         MVC   LXFMTED,F250        Cylinders before stat msg            LXF15220
NXTCYL   DS    0H                                                       LXF15230
*                                                                       LXF15240
*        SET CYLINDER ADDRESS, HEAD ADDRESS, AND WRITE TRACKS           LXF15250
*                                                                       LXF15260
         STH   R7,VSLRSRC          Seek cylinder number in LR plist     LXF15270
         LA    R14,R1COUNT         First count field address            LXF15280
         L     R15,DBLTR           Number of count fields               LXF15290
SETCYLP  DS    0H                                                       LXF15300
         STCM  R7,3,0(R14)         SET CYL NUM IN COUNT FLDS            LXF15310
         LA    R14,8(R14)          NEXT COUNT FIELD                     LXF15320
         BRCT  R15,SETCYLP         LOOP IF MORE REQUIRED                LXF15330
         L     R6,DTRCY            Disk tracks per cylinder             LXF15340
         SPACE 1                                                        LXF15350
NXTHEAD  DS    0H                                                       LXF15360
         STH   R8,VSLRSRH          SET SEEK HEAD ADDRESS                LXF15370
         LA    R14,R1COUNT         FIRST COUNT FIELD ADDRESS            LXF15380
         L     R15,DBLTR           Number of count fields               LXF15390
SETHDLP  DS    0H                                                       LXF15400
         STCM  R8,3,2(R14)         SET HEAD NUM IN COUNT FLDS           LXF15410
         LA    R14,8(,R14)         NEXT COUNT FIELD                     LXF15420
         BRCT  R15,SETHDLP         LOOP IF MORE REQUIRED                LXF15430
         LA    R15,FMTCCWS         CHANNEL PROGRAM ADDRESS              LXF15440
         BRAS  R14,FMTIO           GO DO I/O                            LXF15450
         JNZ   IOERROR             BR IF ANY ERRORS                     LXF15460
         AHI   R8,1                INCR HEAD NUMBER                     LXF15470
         BRCT  R6,NXTHEAD          BR IF CYLINDER NOT DONE              LXF15480
         ST    R7,DFMTCY           Current formatted                    LXF15490
         AHI   R7,1                INCR CYLINDER NUMBER                 LXF15500
         LHI   R8,0                CLEAR HEAD NUMBER                    LXF15510
*                                                                       LXF15520
*        Periodic or requested processing message                       LXF15530
*                                                                       LXF15540
         TM    MSGECB,X'40'        Processing message requested?        LXF15550
         JNO   CKDPRMSG            No, check periodic                   LXF15560
         LR    R3,R7               Next cylinder to format              LXF15570
         BCTR  R3,*-*              Cylinders formatted                  LXF15580
         MH    R3,DBLCY+2          Blocks formatted                     LXF15590
         BRAS  R14,SAYBLKS         Give formatted message               LXF15600
         NI    MSGECB,255-X'40'    Reset message request                LXF15610
         C     R7,LXFMTED          45000 blocks formatted?              LXF15620
         JNH   CKDNOMSG            No, continue                         LXF15630
         J     CKDSUPMS            Update counters                      LXF15640
*                                                                       LXF15650
CKDPRMSG DS    0H                                                       LXF15660
         C     R7,LXFMTED          45000 blocks formatted?              LXF15670
         JNH   CKDNOMSG            No, continue                         LXF15680
         SPACE 1                                                        LXF15690
         TM    FLAG1,MFLG          Periodic msgs wanted?                LXF15700
         JNO   CKDSUPMS            No, just update counters             LXF15710
         SPACE 1                                                        LXF15720
         L     R3,LXFMTED          Current number formated              LXF15730
         MH    R3,DBLCY+2          * blks/cyl               s           LXF15740
         BRAS  R14,SAYBLKS         Give formatted message               LXF15750
         NI    MSGECB,255-X'40'    Reset message request                LXF15760
CKDSUPMS DS    0H                                                       LXF15770
         L     R3,LXFMTED          Current number formated              LXF15780
         AHI   R3,250              Incr for next message                LXF15790
         ST    R3,LXFMTED                                               LXF15800
CKDNOMSG DS    0H                                                       LXF15810
         C     R7,DRDCB            Over max for device?                 LXF15820
         JL    NXTCYL              NO, PROCESS NEXT                     LXF15830
         J     DIRROUT             BUILD DIRECTORY RECORDS              LXF15840
*                                                                       LXF15850
*        Subroutine for I/O errors and end of disk                      LXF15860
*                                                                       LXF15870
IOERROR  DS    0H                                                       LXF15880
         CLI   SGIDEVST,X'0E'      CE + DE + UC ?                       LXF15890
         JNE   ERR07               BR IF NOT                            LXF15900
         SPACE 1                                                        LXF15910
         CLI   SGISDATA,X'81'      SEEK CHECK ?                         LXF15920
         JE    DIRROUT             BR IF YES                            LXF15930
         SPACE 1                                                        LXF15940
         CLI   SGISDATA+1,X'08'   SEEK CHECK ?                          LXF15950
         JE    DIRROUT             BR IF YES                            LXF15960
         SPACE 1                                                        LXF15970
         CLI   SGISDATA,X'80'     SEEK CHECK ?                          LXF15980
         JNE   ERR07               BR IF NOT                            LXF15990
         SPACE 1                                                        LXF16000
*                                                                       LXF16010
*        Subroutine to verify label record                              LXF16020
*                                                                       LXF16030
CHKLBL   DS    0H                                                       LXF16040
         CLC   0(4,R1),VOL1KEY     CDL format?                          LXF16050
         BNER  R7                  No, return                           LXF16060
         SPACE 1                                                        LXF16070
         CLC   11(5,R1),VTOCCHR    VTOC on TRK 1?                       LXF16080
         BNER  R7                  No, we need to recreate              LXF16090
         SPACE 1                                                        LXF16100
         OI    FLAG3,LBLV1         Show no conversion                   LXF16110
         BR    R7                  Return                               LXF16120
         SPACE 1                                                        LXF16130
CHKLBL2  DS    0H                                                       LXF16140
         CLC   0(4,R1),=C'LNX1'    Linux label?                         LXF16150
         BER   R7                  Yes, return                          LXF16160
         SPACE 1                                                        LXF16170
         CLC   0(4,R1),=C'CMS1'    CMS label?                           LXF16180
         BER   R7                  Return                               LXF16190
         SPACE 1                                                        LXF16200
         TM    FLAG1,KFLG          Keep VOLSER requested?               LXF16210
         BNOR  R7                  No, return                           LXF16220
         J     UNKNLBL             No, unknown type                     LXF16230
         EJECT                                                          LXF16240
*                                                                       LXF16250
*        Write FBA VSE IPL, VOL1 and VTOC                               LXF16260
*                                                                       LXF16270
DIRFBA   DS    0H                                                       LXF16280
         MVC   LVOLSER,VOLSER      Set volume serial                    LXF16290
         LHI   R14,0               Clear for divide                     LXF16300
         LR    R15,R7              Total FBA blks formatted             LXF16310
         D     R14,DFBADB          Total data blks formatted            LXF16320
         LR    R7,R15              Set in processing register           LXF16330
         ST    R7,DTOTBK                                                LXF16340
*                                                                       LXF16350
*        Build dummy IPL record                                         LXF16360
*                                                                       LXF16370
         XC    FBAIPL(256),FBAIPL     Clear label block                 LXF16380
         MVC   FBAIPL+256(256),FBAIPL *                                 LXF16390
         MVC   FBAIPL(16),IPL1PD   Set PSW and NO-OP                    LXF16400
         MVI   VTOCCC,X'40'        Flag byte                            LXF16410
         LHI   R1,2                VTOC block number                    LXF16420
         STCM  R1,15,VTOCCC+1      Set in label                         LXF16430
         LHI   R1,1024             FBA CI-Size                          LXF16440
         STCM  R1,15,VOLCISZ       ....                                 LXF16450
         LHI   R1,2                FBA Blocks/CI                        LXF16460
         STCM  R1,15,VOLCIBC       ....                                 LXF16470
         LHI   R1,7                FBA Labels/CI                        LXF16480
         STCM  R1,15,VOLLBCI       ....                                 LXF16490
         XC    FBALABL(256),FBALABL     Clear label block               LXF16500
         MVC   FBALABL+256(256),FBALABL *                               LXF16510
         MVC   FBALABL(80),VOL1DAT                                      LXF16520
*                                                                       LXF16530
*        Build format 4 DSCB                                            LXF16540
*                                                                       LXF16550
         XC    FBAVTOC1(256),FBAVTOC1     Clear first half              LXF16560
         MVC   FBAVTOC1+256(256),FBAVTOC1 Clear second half             LXF16570
         LA    R4,FBAVTOC1         Format 4 DSCB location               LXF16580
         MVI   0(R4),X'04'         F4DSCB Key                           LXF16590
         MVC   1(43,R4),0(R4)      ....                                 LXF16600
         LA    R4,44(,R4)          F4DSCB data                          LXF16610
         USING F4DSCB,R4                                                LXF16620
*        ---------------                                                LXF16630
         MVI   DS4IDFMT,X'F4'      DS4 ID                               LXF16640
         MVI   DS4VTOCI,X'80'      VTOC indicators                      LXF16650
         MVI   DS4NOEXT,X'01'      VTOC extents                         LXF16660
         MVI   DS4VTOCE,X'01'      Flag                                 LXF16670
         MVI   DS4VTOCE+5,X'02'    VTOC starts on block 2               LXF16680
         MVI   DS4VTOCE+9,X'03'    VTOC ends on block 3                 LXF16690
         DROP  R4                                                       LXF16700
*        --------                                                       LXF16710
*                                                                       LXF16720
*        Build format 5 DSCB                                            LXF16730
*                                                                       LXF16740
         LA    R4,96(,R4)          Format 5 DSCB address                LXF16750
         XC    0(44,R4),0(R4)      Clear Key                            LXF16760
         MVI   0(R4),X'05'         F5DSCB Key ID                        LXF16770
         MVC   1(3,R4),0(R5)       Propogate                            LXF16780
         MVI   44(R4),X'F5'        F5DSCB data block ID                 LXF16790
*                                                                       LXF16800
*        Build format 1 DSCB                                            LXF16810
*                                                                       LXF16820
         LA    R4,140(,R4)         Format 1 DSCB address                LXF16830
         USING F1DSCB,R4                                                LXF16840
*        ---------------                                                LXF16850
         MVI   DS1DSNAM,C' '       Set DSN to blanks                    LXF16860
         MVC   DS1DSNAM+1(43),DS1DSNAM Blank dsn                        LXF16870
         MVC   DS1DSNAM(L'LDSN),LDSN Set DS name                        LXF16880
         MVI   DS1FMTID,C'1'       F1DSCB ID                            LXF16890
         MVC   DS1DSSN,VOLSER      F1DSCB DS serial number              LXF16900
         MVI   DS1VOLSQ+1,X'01'    Volume sequence number               LXF16910
         BRAS  R7,CALCDATE         Get date for F1DSCB                  LXF16920
         STCM  R1,7,DS1CREDT       Set creation date                    LXF16930
         STCM  R1,7,DS1REFD        Set referance date                   LXF16940
         LHI   R1,99               EXP year 99                          LXF16950
         SLL   R1,16               Shift to position                    LXF16960
         AHI   R1,365              EXP day 0365                         LXF16970
         STCM  R1,7,DS1EXPDT       Set expiratation date                LXF16980
         MVC   DS1EXPDT,X'000999'  Retention period                     LXF16990
         MVI   DS1NOEPV,X'01'      Extents on volume                    LXF17000
         OI    DS1RECFM,DS1RECFF+DS1RECFS  Fixed and Standard           LXF17010
         MVC   DS1SYSCD,=CL13'IBM LINUX'                                LXF17020
         MVI   DS1SCXTV+1,X'02'    2 blocks/CI                          LXF17030
         MVI   DS1DSORG,X'40'      SAM dataset                          LXF17040
         L     R1,DBLKSZ           Format block size                    LXF17050
         STCM  R1,3,DS1BLKL        as block size                        LXF17060
         STCM  R1,3,DS1LRECL       and logical record length            LXF17070
         OI    DS1DSIND,DS1IND80   Last volome for sam dataset          LXF17080
         MVI   DS1SCALO,X'04'      Max continuous extent                LXF17090
         MVI   DS1EXT1,X'01'       Prime data area                      LXF17100
         MVI   DS1EXT1+1,X'01'     Extent number                        LXF17110
         MVI   DS1EXT1+5,X'04'     Starts on block 4                    LXF17120
         L     R1,DTOTBK           Blocks formatted                     LXF17130
         MH    R1,DFBADB+2         * FBA blks per data block            LXF17140
         BCTR  R1,*-*              Base zero                            LXF17150
         STCM  R1,15,DS1EXT1+6     Set ending block number              LXF17160
         DROP  R4                                                       LXF17170
*        --------                                                       LXF17180
         BRAS  R14,SHOWMAPN        Show FBA diskmap                     LXF17190
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF17200
         TM    FLAG1,FFLG          Did we format?                       LXF17210
         JO    FNVFBA              Yes, verify done                     LXF17220
         SPACE 1                                                        LXF17230
         BRAS  R7,VERFMT           Ask question                         LXF17240
FNVFBA   DS    0H                                                       LXF17250
*                                                                       LXF17260
*        Write VOL1 in block 1                                          LXF17270
*                                                                       LXF17280
         MVC   FBALABL+4(6),VOLSER Set volume serial                    LXF17290
         LHI   R1,1                Write VOL1 to FBA blk 1              LXF17300
         STH   R1,VSLFBCT          FBA block count                      LXF17310
         ST    R1,VSLFFDE          Set in locate plist                  LXF17320
         LHI   R1,512              FBA VOL1 data length                 LXF17330
         STH   R1,FBADCCW+2        Set in FBA data CCW                  LXF17340
         LA    R1,FBALABL          FBA VOL1 data address                LXF17350
         ST    R1,FBADCCW+4        Set in FBA data CCW                  LXF17360
         LA    R15,FBADATA         Write VOL1 record                    LXF17370
         BRAS  R14,FMTIO4          Do I/O                               LXF17380
         JNZ   ERR07FBA            Message and exit if error            LXF17390
*                                                                       LXF17400
*        Write VTOC in block 2                                          LXF17410
*                                                                       LXF17420
         LHI   R1,2                Write VTOC to FBA block 2            LXF17430
         ST    R1,VSLFFDE          Set in locate plist                  LXF17440
         LA    R1,FBAVTOC1         FBA VTOC data address                LXF17450
         ST    R1,FBADCCW+4        Set in FBA data CCW                  LXF17460
         LA    R15,FBADATA         Write VTOC record                    LXF17470
         BRAS  R14,FMTIO4          ....                                 LXF17480
         JNZ   ERR07FBA            Message and exit if error            LXF17490
         SPACE 1                                                        LXF17500
         TM    FLAG1,FFLG          Did we format?                       LXF17510
         JNO   SAYDONE             No, we're done                       LXF17520
*                                                                       LXF17530
*        Write dummy IPL record                                         LXF17540
*                                                                       LXF17550
         LHI   R1,0                Write IPL1 to FBA blk 0              LXF17560
         ST    R1,VSLFFDE          Set in locate plist                  LXF17570
         LA    R1,FBAIPL           FBA IPL1 data address                LXF17580
         ST    R1,FBADCCW+4        Set in FBA data CCW                  LXF17590
         LA    R15,FBADATA         Write IPL record                     LXF17600
         BRAS  R14,FMTIO4          ....                                 LXF17610
         JNZ   ERR07FBA            Message and exit if error            LXF17620
         SPACE 1                                                        LXF17630
         J     SAYDONE             We're done                           LXF17640
         EJECT                                                          LXF17650
*                                                                       LXF17660
*        Write ECKD tracks 0 and 1                                      LXF17670
*                                                                       LXF17680
DIRROUT  DS    0H                                                       LXF17690
         LTR   R7,R7               Any cylinders formatted?             LXF17700
         JZ    ERR05               No, exit with error                  LXF17710
         SPACE 1                                                        LXF17720
         LTR   R8,R8               Full cylinders?                      LXF17730
         JNZ   ERR05               No, exit with error                  LXF17740
         SPACE 1                                                        LXF17750
         MVC   LVOLSER,VOLSER      Set volume serial                    LXF17760
         ST    R7,DFMTCY           Formatted cylinders                  LXF17770
         MH    R7,DBLCY+2          Total blocks                         LXF17780
         ST    R7,DTOTBK           Save for message                     LXF17790
*                                                                       LXF17800
CHKNVOL  DS    0H                                                       LXF17810
*                                                                       LXF17820
*        Build VTOC                                                     LXF17830
*                                                                       LXF17840
*                                                                       LXF17850
*        Build format 4 DSCB                                            LXF17860
*                                                                       LXF17870
         USING F4DSCB,R4                                                LXF17880
*        ---------------                                                LXF17890
         LA    R4,F4BF1DA          F4 buffer                            LXF17900
         XC    F4BF1DA,F4BF1DA     Clear data portion                   LXF17910
         MVI   F4BF1KY,X'04'         Setup the key                      LXF17920
         MVC   DSCBKEY+1(43),DSCBKEY *                                  LXF17930
         MVI   DS4IDFMT,X'F4'      Format ID                            LXF17940
         LHI   R0,2                Two DSCBs in use                     LXF17950
         TM    FLAG3,NEEDF7        Do we need a F7?                     LXF17960
         JNO   DOFMT1S             No, continue                         LXF17970
         AHI   R0,1                One more for F7                      LXF17980
         OI    DS4EFLVL,DS4EFL07   Show extended free space             LXF17990
         LHI   R1,1                Source of 1                          LXF18000
         STCM  R1,15,DS4EFPTR      F7 will be on track one              LXF18010
         LHI   R1,3                Record 3                             LXF18020
         STC   R1,DS4EFPTR+4       ....                                 LXF18030
DOFMT1S  DS    0H                                                       LXF18040
         L     R1,DBLTR            Total DSCBs                          LXF18050
         STC   R1,DS4DEVDT         DSCS's per track                     LXF18060
         LHI   R15,0               Clear for last F1 DSCB               LXF18070
         TM    FLAG2,NFLG          No F1 DSCBs?                         LXF18080
         JO    F4F1DONE            Yes, fields correct                  LXF18090
         SPACE 1                                                        LXF18100
         MVI   DS4HPCHR+3,X'01'    Show high F1 on trk 1                LXF18110
         LHI   R15,3               High F1 DSCB rec num                 LXF18120
         AHI   R0,1                At least 1 F1 DSCD                   LXF18130
         TM    FLAG2,P2FLG         2 F1 DSCBs?                          LXF18140
         JNO   F4F1DONE            No, done F1 DSCBs                    LXF18150
         SPACE 1                                                        LXF18160
         AHI   R0,1                Incr for 2nd partition               LXF18170
         AHI   R15,1               Incr high F1 DSCB rec num            LXF18180
         TM    FLAG2,P3FLG         3 F1 DSCBs?                          LXF18190
         JNO   F4F1DONE            No, done F1 DSCBs                    LXF18200
         SPACE 1                                                        LXF18210
         AHI   R0,1                Incr for 3nd partition               LXF18220
         AHI   R15,1               Incr high F1 DSCB rec num            LXF18230
         SPACE 1                                                        LXF18240
F4F1DONE DS    0H                                                       LXF18250
         STC   R15,DS4HPCHR+4      Set high F1 DSCB rec num             LXF18260
         SR    R1,R0               Minus in_use                         LXF18270
         STCM  R1,3,DS4DSREC       Set available DSCB count             LXF18280
         MVI   DS4NOEXT,X'01'      One extent in VTOC                   LXF18290
         MVC   DS4DSCYL,DFMTCY+2   Total disk cylinders                 LXF18300
         MVC   DS4DSTRK,DTRCY+2    Tracks per cylinder                  LXF18310
         MVC   DS4DEVTK,VRDCTOTR+1 Track usable space                   LXF18320
         OI    DS4DEVFG,DS4DSF+DS4DEVAV flags                           LXF18330
         LHI   R1,1                                                     LXF18340
         STC   R1,DS4VTOCE         EXT User                             LXF18350
         STCM  R1,15,DS4VTOCE+2    Starts on track one                  LXF18360
         STCM  R1,15,DS4VTOCE+6    Ends on track one                    LXF18370
         DROP  R4                                                       LXF18380
*        --------                                                       LXF18390
*                                                                       LXF18400
*        Build format 5 DSCD                                            LXF18410
*                                                                       LXF18420
         LA    R4,F5BF1KY          F5 is full dsect                     LXF18430
         USING F5DSCB,R4           Address ability for F5DSCB           LXF18440
*        ---------------                                                LXF18450
         XC    F5BF1KY(44+96),F5BF1KY  Clear key & data                 LXF18460
         MVI   F5BF1KY,X'05'                                            LXF18470
         MVC   F5BF1KY+1(3),DSCBKEY Propogate key ID                    LXF18480
         MVI   DS5FMTID,X'F5'      Set data record ID                   LXF18490
         TM    FLAG3,NEEDF7        Going to write an F7?                LXF18500
         JO    BLDF7               Yes, F5 is dummy                     LXF18510
*                                                                       LXF18520
*        Setup free space in format 5                                   LXF18530
*                                                                       LXF18540
         LA    R3,DS5AVEXT         First extent address                 LXF18550
         LHI   R7,1                Last used vtoc track                 LXF18560
         LA    R8,P1START          First partition start                LXF18570
         BRAS  R14,CALCFSPC        Calculate the free space             LXF18580
         J     F5LAST              Returns here if parts done           LXF18590
         SPACE 1                                                        LXF18600
         LA    R7,P1END            End of last                          LXF18610
         LA    R8,P2START          Start of next                        LXF18620
         BRAS  R14,CALCFSPC        Calculate the free space             LXF18630
         J     F5LAST              Returns here if parts done           LXF18640
         SPACE 1                                                        LXF18650
         LA    R7,P2END            End of last                          LXF18660
         LA    R8,P3START          Start of next                        LXF18670
         BRAS  R14,CALCFSPC        Calculate the free space             LXF18680
         J     F5LAST              Returns here if parts done           LXF18690
         SPACE 1                                                        LXF18700
         LHI   R1,0                                                     LXF18710
         ICM   R1,3,P3END          P3 ending cylinder                   LXF18720
         MH    R1,DTRCY+2          Tracks                               LXF18730
         AH    R1,P3END+2          Ending track                         LXF18740
         AHI   R1,1                S/B start of next                    LXF18750
F5LAST   DS    0H                                                       LXF18760
         L     R2,DTOTR            Total tracks                         LXF18770
         SR    R2,R1                                                    LXF18780
         JZ    P5DONE              No, done with free space             LXF18790
         SPACE 1                                                        LXF18800
         STCM  R1,3,0(R3)          Starting track                       LXF18810
         LR    R1,R2               Available tracks                     LXF18820
         LHI   R0,0                Clear for divide                     LXF18830
         D     R0,DTRCY            Tracks and cylinders                 LXF18840
         STCM  R1,3,2(R3)          Full cylinders                       LXF18850
         STC   R0,4(,R3)           Additional tracks                    LXF18860
         LA    R3,5(,R3)           Next extent slot                     LXF18870
P5DONE   DS    0H                                                       LXF18880
         J     BLDF1               Build the format 1 DSCB's            LXF18890
         DROP  R4                                                       LXF18900
*        --------                                                       LXF18910
*                                                                       LXF18920
*        Build format 7 DSCB if required                                LXF18930
*                                                                       LXF18940
BLDF7    DS    0H                                                       LXF18950
         USING F7DSCB,R4           Address ability for F5DSCB           LXF18960
         LA    R4,F7BF1KY          F7 DSCB buffer                       LXF18970
         XC    F7BF1KY(44+96),F7BF1KY  Clear key & data                 LXF18980
         MVI   F7BF1KY,x'07'       Key ID                               LXF18990
         MVC   F7BF1KY+1(3),F7BF1KY Propogate key ID                    LXF19000
         MVI   DS7FMTID,X'F7'      Set data record ID                   LXF19010
*                                                                       LXF19020
*        Setup free space in format 7                                   LXF19030
*                                                                       LXF19040
         LA    R3,DS7AVEXT         First extent address                 LXF19050
         LHI   R7,1                Last used vtoc track                 LXF19060
         LA    R8,P1START          First partition start                LXF19070
         BRAS  R14,CALCFSPC        Calculate the free space             LXF19080
         J     F7LAST              Returns here if parts done           LXF19090
         SPACE 1                                                        LXF19100
         LA    R7,P1END            End of last                          LXF19110
         LA    R8,P2START          Start of next                        LXF19120
         BRAS  R14,CALCFSPC        Calculate the free space             LXF19130
         J     F7LAST              Returns here if parts done           LXF19140
         SPACE 1                                                        LXF19150
         LA    R7,P2END            End of last                          LXF19160
         LA    R8,P3START          Start of next                        LXF19170
         BRAS  R14,CALCFSPC        Calculate the free space             LXF19180
         J     F7LAST              Returns here if parts done           LXF19190
         SPACE 1                                                        LXF19200
         LHI   R1,0                Clear for insert                     LXF19210
         ICM   R1,3,P3END          P3 ending cylinder                   LXF19220
         MH    R1,DTRCY+2          Tracks                               LXF19230
         AH    R1,P3END+2          Ending tracks                        LXF19240
         AHI   R1,1                S/B start of next                    LXF19250
F7LAST   DS    0H                                                       LXF19260
         L     R2,DTOTR            Total tracks                         LXF19270
         SR    R2,R1                                                    LXF19280
         JZ    F7DONE              No, done with free space             LXF19290
         SPACE 1                                                        LXF19300
         STCM  R1,15,0(R3)         Starting track                       LXF19310
         STCM  R2,15,4(R3)         Available tracks                     LXF19320
         SPACE 1                                                        LXF19330
F7DONE   DS    0H                                                       LXF19340
*                                                                       LXF19350
*        Build format 1 DSCB's                                          LXF19360
*                                                                       LXF19370
BLDF1    DS    0H                                                       LXF19380
         TM    FLAG2,NFLG          No F1 DSCBs                          LXF19390
         JO    T1F1DONE            Yes, we're done                      LXF19400
         SPACE 1                                                        LXF19410
         USING F1DSCB,R4                                                LXF19420
*        ---------------                                                LXF19430
         LA    R4,F1BF1KY          1st F1 DSCB buffer                   LXF19440
*                                                                       LXF19450
*        Setup  common format 1 info                                    LXF19460
*                                                                       LXF19470
         XC    F1BF1KY(44+96),F1BF1KY  Clear key & data                 LXF19480
         XC    F1BF2KY(44+96),F1BF2KY  Clear key & data                 LXF19490
         XC    F1BF3KY(44+96),F1BF3KY  Clear key & data                 LXF19500
         MVI   DS1DSNAM,C' '       Set DSN to blanks                    LXF19510
         MVC   DS1DSNAM+1(43),DS1DSNAM Blank dsn                        LXF19520
         MVC   DS1DSNAM(L'LDSN),LDSN Set DS name                        LXF19530
         MVI   DS1FMTID,C'1'       F1DSCB ID                            LXF19540
         MVC   DS1DSSN,VOLSER      F1DSCB DS serial number              LXF19550
         MVI   DS1VOLSQ+1,X'01'    Volume sequence number               LXF19560
         BRAS  R7,CALCDATE         Get date for F1DSCB                  LXF19570
         STCM  R1,7,DS1CREDT       Set creation date                    LXF19580
         STCM  R1,7,DS1REFD        Set referance date                   LXF19590
         LHI   R1,99               EXP year 99                          LXF19600
         SLL   R1,16               Shift to position                    LXF19610
         AHI   R1,365              EXP day 0365                         LXF19620
         STCM  R1,7,DS1EXPDT       Set expiratation date                LXF19630
         MVI   DS1NOEPV,X'01'      Extents on volume                    LXF19640
         MVC   DS1SYSCD,=CL13'IBM LINUX'                                LXF19650
         MVI   DS1SCXTV+1,X'02'    2 blocks/CI                          LXF19660
         MVI   DS1DSORG,X'40'      SAM dataset                          LXF19670
         L     R1,DBLKSZ           Format block size                    LXF19680
         STCM  R1,3,DS1BLKL        as block size                        LXF19690
         STCM  R1,3,DS1LRECL       and logical record length            LXF19700
         OI    DS1DSIND,DS1IND80   Last volome for sam dataset          LXF19710
         OI    DS1RECFM,DS1RECFF+DS1RECFS  Fixed and Standard           LXF19720
         OI    DS1SCALO,X'80'      Track request                        LXF19730
         MVI   DS1EXT1,X'01'       Prime data area                      LXF19740
*                                                                       LXF19750
*        Check for P1, P2, P3                                           LXF19760
*                                                                       LXF19770
         MVC   DS1EXT1+2(8),P1START Set extents                         LXF19780
         TM    FLAG2,P2FLG         P2 requested?                        LXF19790
         JNO   T1F1DONE            No, we're done                       LXF19800
         SPACE 1                                                        LXF19810
         MVC   F1BF2KY(44+96),F1BF1KY Set up F1 DSCB 2                  LXF19820
         LA    R4,F1BF2KY          2nd F1 DSCB buffer                   LXF19830
         MVC   DS1EXT1+2(8),P2START Set extents                         LXF19840
         MVI   DS1DSNAM+(LPARTNM-LDSN+3),C'2'                           LXF19850
         TM    FLAG2,P3FLG         P3 requested?                        LXF19860
         JNO   T1F1DONE            No, we're done                       LXF19870
         SPACE 1                                                        LXF19880
         MVC   F1BF3KY(44+96),F1BF1KY Set up F1 DSCB 3                  LXF19890
         LA    R4,F1BF3KY          Address of P1 DSCB                   LXF19900
         MVC   DS1EXT1+2(8),P3START Set extents                         LXF19910
         MVI   DS1DSNAM+(LPARTNM-LDSN+3),C'3'                           LXF19920
         DROP  R4                                                       LXF19930
*        --------                                                       LXF19940
T1F1DONE DS    0H                                                       LXF19950
         BRAS  R14,SHOWMAPN        Show the disk map                    LXF19960
         TM    FLAG1,FFLG          Doing a format                       LXF19970
         JO    FMTRK0              Yes, format the label track          LXF19980
         SPACE 1                                                        LXF19990
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF20000
         BRAS  R7,VERFMT           Verify request                       LXF20010
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF20020
*                                                                       LXF20030
*        Write track zero                                               LXF20040
*                                                                       LXF20050
         TM    FLAG3,LBLV1         Need to convert?                     LXF20060
         JNO   FMTRK0              Yes, format the label track          LXF20070
         SPACE 1                                                        LXF20080
         TM    FLAG3,VOLSERF       Volser entered?                      LXF20090
         JO    WRTLBL              Yes, write the label                 LXF20100
         SPACE 1                                                        LXF20110
         CLC   LVOL1+4(6),VOLSER   Set new volume serial                LXF20120
         JNE   WRTLBL              Yes, write the label                 LXF20130
         SPACE 1                                                        LXF20140
         TM    FLAG1,KFLG          Keep volser?                         LXF20150
         JO    WRTLBL              Yes, write the label                 LXF20160
         J     FMTRK1              Format the VTOC                      LXF20170
         SPACE 1                                                        LXF20180
FMTRK0   DS    0H                                                       LXF20190
         LHI   R1,0                Source of zero                       LXF20200
         LA    R14,R1COUNT         First count field address            LXF20210
         L     R15,DBLTR           Number of count fields               LXF20220
TRK0LP   DS    0H                                                       LXF20230
         STCM  R1,15,0(R14)        Set cyl & head in count fields       LXF20240
         LA    R14,8(,R14)         Next count field                     LXF20250
         BRCT  R15,TRK0LP          Loop if more required                LXF20260
         SPACE 1                                                        LXF20270
         MVI   VSLROP,VSLRFW       Set locate op to format write        LXF20280
         XC    VSLRSRC(4),VSLRSRC  Set for track zero                   LXF20290
         LA    R15,FMTCCWS+24      Continuation for trk 0 recs          LXF20300
         ST    R15,TRK0TIC+4       Set in TIC                           LXF20310
         LA    R15,TRK0CCWS        ....                                 LXF20320
         BRAS  R14,FMTIO           Write track zero                     LXF20330
         JNZ   ERR07               Exit on I/O error                    LXF20340
         J     FMTRK1              Bypass label write                   LXF20350
*                                                                       LXF20360
*        UPDATE the label                                               LXF20370
*                                                                       LXF20380
WRTLBL   DS    0H                                                       LXF20390
         MVC   LVOL1+4(6),VOLSER   Set new volume serial                LXF20400
         XC    VSLRSRC(4),VSLRSRC  Set for track zero                   LXF20410
         MVI   VSLRSRR,X'03'       Record 3                             LXF20420
         MVI   VSLROP,VSLRWD       Set locate op to write data          LXF20430
         MVI   BLOKCCW,X'85'       Set write CCW opcode                 LXF20440
         LHI   R15,80              Label record length                  LXF20450
         STH   R15,BLOKCCW+2       Set in data CCW                      LXF20460
         STH   R15,VSDEBLK         Also in DE blk size                  LXF20470
         LA    R15,LVOL1           Buffer address                       LXF20480
         ST    R15,BLOKCCW+4       Set in CCW                           LXF20490
         LA    R15,BLOKCCW         CKD CCW address                      LXF20500
         BRAS  R14,FMTIO           Write the label                      LXF20510
         JNZ   ERR07               Exit on I/O error                    LXF20520
*                                                                       LXF20530
*        Write format 0 dscbs on track one                              LXF20540
*                                                                       LXF20550
FMTRK1   DS    0H                                                       LXF20560
         LHI   R0,1                Cylinder zero Head 1                 LXF20570
         LA    R1,R1COUNT          Record count fields                  LXF20580
         LHI   R2,44               Key length                           LXF20590
         LHI   R3,96               Data length                          LXF20600
         L     R15,DBLTR           Number of count fields               LXF20610
         USING HCCW,R14                                                 LXF20620
*        --------------                                                 LXF20630
SETDSCB  DS    0H                                                       LXF20640
         STCM  R0,15,0(R1)         Set CCHH                             LXF20650
         STC   R2,5(,R1)           Key length in count field            LXF20660
         STCM  R3,3,6(R1)          Data length in count field           LXF20670
         LA    R1,8(,R1)           Next count filed                     LXF20680
         BRCT  R15,SETDSCB         Loop through CCWs                    LXF20690
         SPACE 1                                                        LXF20700
         MVI   VSLROP,VSLRFW       Set locate op to format write        LXF20710
         LHI   R15,44+96           DSCB length                          LXF20720
         STH   R15,VSDEBLK         Set in DE blk size                   LXF20730
         L     R1,DBLTR            BLKS/TRK                             LXF20740
         STC   R1,VSLRRC           Set in LR plist                      LXF20750
         LHI   R1,1                Set for track one                    LXF20760
         STCM  R1,15,VSLRSRC       ....                                 LXF20770
         MVI   VSLRSRR,X'00'       Record 0                             LXF20780
         LA    R15,FMTCCWS         CCWs to format track                 LXF20790
         BRAS  R14,FMTIO           Format VTOC track                    LXF20800
         JNZ   ERR07               Exit if any errors                   LXF20810
*                                                                       LXF20820
*        Write format 4 DSCB                                            LXF20830
*                                                                       LXF20840
         LHI   R2,1                First DSCB record number             LXF20850
         LHI   R1,44+96            Length of key + data                 LXF20860
         STH   R1,VSDEBLK          Set in DE blk size                   LXF20870
         MVI   VSLROP,VSLRWD       Set locate op to wrt data            LXF20880
         MVI   VSLRRC,X'01'        Set record count                     LXF20890
         STC   R2,VSLRSRR          Set record number                    LXF20900
         LA    R15,F4BF1KY         Buffer address                       LXF20910
         ST    R15,DSCBWRT+4       Set in CCW                           LXF20920
         LA    R15,DSCBWRT         DSCB key/data address                LXF20930
         BRAS  R14,FMTIO           Write key and data                   LXF20940
         JNZ   ERR07               Message and exit if error            LXF20950
         SPACE 1                                                        LXF20960
         AHI   R2,1                Next record number                   LXF20970
*                                                                       LXF20980
*        Write format 5 DSCB                                            LXF20990
*                                                                       LXF21000
         STC   R2,VSLRSRR          Set record number                    LXF21010
         LA    R15,F5BF1KY         Buffer address                       LXF21020
         ST    R15,DSCBWRT+4       Set in CCW                           LXF21030
         LA    R15,DSCBWRT         DSCB key/data address                LXF21040
         BRAS  R14,FMTIO           Write key and data                   LXF21050
         JNZ   ERR07               Message and exit if error            LXF21060
         AHI   R2,1                Next record number                   LXF21070
*                                                                       LXF21080
*        Write format 7 DSCB                                            LXF21090
*                                                                       LXF21100
         TM    FLAG3,NEEDF7        Need an F7 DSCB?                     LXF21110
         JNO   WRTF1               No, process format 1s                LXF21120
         SPACE 1                                                        LXF21130
         STC   R2,VSLRSRR          Set record number                    LXF21140
         LA    R15,F7BF1KY         F7 DSCB buffer address               LXF21150
         ST    R15,DSCBWRT+4       Set in CCw                           LXF21160
         LA    R15,DSCBWRT         DSCB key/data address                LXF21170
         BRAS  R14,FMTIO           Write key and data                   LXF21180
         JNZ   ERR07               Message and exit if error            LXF21190
         SPACE 1                                                        LXF21200
         AHI   R2,1                Next record number                   LXF21210
*                                                                       LXF21220
*        Write 1st format 1 DSCB                                        LXF21230
*                                                                       LXF21240
WRTF1    DS    0H                                                       LXF21250
         TM    FLAG2,NFLG          Creating partitions?                 LXF21260
         JO    SAYDONE             No, we're done                       LXF21270
         SPACE 1                                                        LXF21280
         STC   R2,VSLRSRR          Set record number                    LXF21290
         LA    R15,F1BF1KY         First format 1 DSCB address          LXF21300
         ST    R15,DSCBWRT+4       Set in CCW                           LXF21310
         LA    R15,DSCBWRT         DSCB key/data address                LXF21320
         BRAS  R14,FMTIO           Write key and data                   LXF21330
         JNZ   ERR07               Message and exit if error            LXF21340
         SPACE 1                                                        LXF21350
         TM    FLAG2,P2FLG         P2 requested?                        LXF21360
         JNO   SAYDONE             No, we're done                       LXF21370
*                                                                       LXF21380
*        Write 2nd format DSCB                                          LXF21390
*                                                                       LXF21400
         AHI   R2,1                Next record number                   LXF21410
         STC   R2,VSLRSRR          Set record number                    LXF21420
         LA    R15,F1BF2KY         2nd format 1 DSCB address            LXF21430
         ST    R15,DSCBWRT+4       Set in CCW                           LXF21440
         LA    R15,DSCBWRT         DSCB key/data address                LXF21450
         BRAS  R14,FMTIO           Write key and data                   LXF21460
         JNZ   ERR07               Message and exit if error            LXF21470
         SPACE 1                                                        LXF21480
         TM    FLAG2,P3FLG         P3 requested?                        LXF21490
         JNO   SAYDONE             No, we're done                       LXF21500
*                                                                       LXF21510
*        Write 3rd format 1 DSCB                                        LXF21520
*                                                                       LXF21530
         AHI   R2,1                Next record number                   LXF21540
         STC   R2,VSLRSRR          Set record number                    LXF21550
         LA    R15,F1BF3KY         3rd format 1 DSCB address            LXF21560
         ST    R15,DSCBWRT+4       Set in CCW                           LXF21570
         LA    R15,DSCBWRT         DSCB key/data address                LXF21580
         BRAS  R14,FMTIO           Write key and data                   LXF21590
         JNZ   ERR07               Message and exit if error            LXF21600
         J     SAYDONE             Say processing is done               LXF21610
         SPACE 1                                                        LXF21620
         USING HCCW,R14                                                 LXF21630
*        --------------                                                 LXF21640
*======================== End of Routine ====================*          LXF21650
         EJECT                                                          LXF21660
*============================================================*          LXF21670
*                                                            *          LXF21680
* Name     - CALCDATE.                                       *          LXF21690
*                                                            *          LXF21700
* Function - Setup YY0DDD in binary.                         *          LXF21710
*                                                            *          LXF21720
* On Entry - R14 - Link register                             *          LXF21730
*            R3  - CCHH                                      *          LXF21740
*                                                            *          LXF21750
* On Exit  - R1  - Date in binary.                           *          LXF21760
*                                                            *          LXF21770
*============================================================*          LXF21780
         SPACE 1                                                        LXF21790
CALCDATE DS    0H                                                       LXF21800
         SPACE 1                                                        LXF21810
         TIME  DEC                                                      LXF21820
         SPACE 1                                                        LXF21830
         ST    R1,DWORK1             Store the date                     LXF21840
         UNPK  DWORK2(5),DWORK1+1(3) Unpack it                          LXF21850
         PACK  DWORK3(8),DWORK2(2)   Pack the year                      LXF21860
         CVB   R1,DWORK3             Convert it to binary               LXF21870
         LHI   R0,0                  Clear for insert                   LXF21880
         IC    R0,DWORK1             Century byte                       LXF21890
CENTLP   DS    0H                                                       LXF21900
         AHI   R1,100                Add 100 years                      LXF21910
         BRCT  R0,CENTLP             Loop if past 2100                  LXF21920
         SLL   R1,16                 Shift into position                LXF21930
         PACK  DWORK3(8),DWORK2+2(3) Pack the day of the yesr           LXF21940
         CVB   R0,DWORK3             Convert it to binary               LXF21950
         OR    R1,R0                 Set 0DDD in date                   LXF21960
         BR    R7                    Return                             LXF21970
         SPACE 1                                                        LXF21980
*======================== End of Routine ====================*          LXF21990
         EJECT                                                          LXF22000
*============================================================*          LXF22010
*                                                            *          LXF22020
* Name     - CALCFSPC.                                       *          LXF22030
*                                                            *          LXF22040
* Function - Calculate free space.                           *          LXF22050
*                                                            *          LXF22060
* On Entry - R14 - Link register                             *          LXF22070
*            R7  - CCHH                                      *          LXF22080
*                                                            *          LXF22090
* On Exit  -                                                 *          LXF22100
*                                                            *          LXF22110
*============================================================*          LXF22120
         SPACE 1                                                        LXF22130
*                                                                       LXF22140
*        Calculate free space                                           LXF22150
*                                                                       LXF22160
CALCFSPC DS    0H                                                       LXF22170
         LHI   R1,0                Clear for insert                     LXF22180
         ICM   R1,3,0(R7)          Cylinder start                       LXF22190
         MH    R1,DTRCY+2          Tracks                               LXF22200
         AH    R1,2(,R7)           Start track                          LXF22210
         LA    R1,1(,R1)           S/B start of next                    LXF22220
         LHI   R2,0                Clear for insert                     LXF22230
         ICM   R2,3,0(R8)          Cylinder                             LXF22240
         MH    R2,DTRCY+2          Tracks                               LXF22250
         AH    R2,2(,R8)           End track                            LXF22260
         LTR   R2,R2               Any partitions?                      LXF22270
         BZR   R14                 No, all free space                   LXF22280
         SPACE 1                                                        LXF22290
         SR    R2,R1               Free space tracks                    LXF22300
         BNP   4(R14)              No free space                        LXF22310
         SPACE 1                                                        LXF22320
         TM    FLAG3,NEEDF7        Processing F7?                       LXF22330
         JO    FSPCF7              Yes, set up F7                       LXF22340
         SPACE 1                                                        LXF22350
         STCM  R1,3,0(R3)          Starting track                       LXF22360
         LR    R1,R2               Available tracks                     LXF22370
         LHI   R0,0                Clear for divide                     LXF22380
         D     R0,DTRCY            Tracks and cylinders                 LXF22390
         STCM  R1,3,2(R3)          Full cylinders                       LXF22400
         STC   R0,4(,R3)           Additional tracks                    LXF22410
         LA    R3,5(,R3)           Next extent slot                     LXF22420
         B     4(R14)                                                   LXF22430
         SPACE 1                                                        LXF22440
FSPCF7   DS    0H                                                       LXF22450
         STCM  R1,15,0(R3)         Set start track                      LXF22460
         STCM  R2,15,4(R3)         Available tracks                     LXF22470
         LA    R3,8(,R3)           Next extent slot                     LXF22480
         B     4(R14)                                                   LXF22490
         SPACE 1                                                        LXF22500
*======================== End of Routine ====================*          LXF22510
         EJECT                                                          LXF22520
*============================================================*          LXF22530
*                                                            *          LXF22540
* Name     - SETPART.                                        *          LXF22550
*                                                            *          LXF22560
* Function - Convert partition start and end tracks to CCHH. *          LXF22570
*                                                            *          LXF22580
* On Entry - R7  - Link register                             *          LXF22590
*            R3  - CCHH                                      *          LXF22600
*                                                            *          LXF22610
* On Exit  -                                                 *          LXF22620
*                                                            *          LXF22630
*============================================================*          LXF22640
         SPACE 1                                                        LXF22650
SETPART  DS    0H                                                       LXF22660
         L     R1,0(,R3)           First track                          LXF22670
         LHI   R0,0                Clear for divide                     LXF22680
         D     R0,DTRCY            CYL in R1 Tracks in R0               LXF22690
         STCM  R1,3,0(R3)          Set cylinder                         LXF22700
         STCM  R0,3,2(R3)          Set head                             LXF22710
         CLC   4(4,R3),=C'LAST '   Requesting last?                     LXF22720
         JNE   SETPART2            No do conversion                     LXF22730
         SPACE 1                                                        LXF22740
         L     R1,DRDCB            Total cylinders                      LXF22750
         BCTR  R1,*-*              Base zero                            LXF22760
         STCM  R1,3,4(R3)          Set cylinder number                  LXF22770
         L     R1,DTRCY            Tracks/Cylinder                      LXF22780
         BCTR  R1,*-*              Base zero                            LXF22790
         STCM  R1,3,6(R3)          Set head number                      LXF22800
         BR    R7                  Return                               LXF22810
         SPACE 1                                                        LXF22820
SETPART2 DS    0H                                                       LXF22830
         L     R1,4(,R3)            Last track                          LXF22840
         LHI   R0,0                Clear for divide                     LXF22850
         D     R0,DTRCY            CYL in R1 Tracks in R0               LXF22860
         STCM  R1,3,4(R3)          Set cylinder                         LXF22870
         STCM  R0,3,6(R3)          Set head                             LXF22880
*                                                                       LXF22890
*        Validate partition                                             LXF22900
*                                                                       LXF22910
         CLC   0(2,R3),H0          Cylinder zero?                       LXF22920
         JH    VALPART             Yes, no head check                   LXF22930
         SPACE 1                                                        LXF22940
         LA    R6,PEMSG1           In label or VTOC                     LXF22950
         CLC   2(2,R3),H1          > track 1?                           LXF22960
         JNH   PERROR              No, invalid                          LXF22970
         SPACE 1                                                        LXF22980
VALPART  DS    0H                                                       LXF22990
         LA    R6,PEMSG2           Exceeds disk size                    LXF23000
         CLC   4(2,R3),DRDCB+2     Exceed disk size?                    LXF23010
         JNL   PERROR              Yes, invalid                         LXF23020
         SPACE 1                                                        LXF23030
         LA    R14,PEMSG3          Start > end                          LXF23040
         CLC   0(2,R3),4(R3)       Check cylinder                       LXF23050
         JE    PCHKHH              Equal,check head                     LXF23060
         BLR   R7                  Low, return                          LXF23070
         J     PERROR                                                   LXF23080
         SPACE 1                                                        LXF23090
PCHKHH   DS    0H                                                       LXF23100
         CLC   2(3,R3),6(R3)       Check head                           LXF23110
         BNHR  R7                  1 or more tracks ok                  LXF23120
         SPACE 1                                                        LXF23130
PERROR   DS    0H                                                       LXF23140
         BRAS  R14,PARTERR         Issue message                        LXF23150
         BR    R7                  Return                               LXF23160
         SPACE 1                                                        LXF23170
*======================== End of Mainline ===================*          LXF23180
         EJECT                                                          LXF23190
*============================================================*          LXF23200
*                                                            *          LXF23210
* Name     - SHOWMAPC.                                       *          LXF23220
*                                                            *          LXF23230
* Function - Show allocation map.                            *          LXF23240
*                                                            *          LXF23250
* On Entry - R14 - Link register                             *          LXF23260
*                                                            *          LXF23270
* On Exit  -                                                 *          LXF23280
*                                                            *          LXF23290
*============================================================*          LXF23300
         SPACE 1                                                        LXF23310
SHOWMAPC DS    0H                                                       LXF23320
         LA    R2,MAPCUR           CURRENT keyword                      LXF23330
         LA    R7,L'MAPCUR         Keyword length                       LXF23340
         LA    R3,LVOL1+4          ECKD volser address                  LXF23350
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF23360
         JNE   SHOWMAP             No, continue                         LXF23370
         SPACE 1                                                        LXF23380
         LA    R3,FBALABL+4        FBA VOLSER address                   LXF23390
         J     SHOWMAP                                                  LXF23400
SHOWMAPN DS    0H                                                       LXF23410
         LA    R2,MAPNEW           NEW keyword                          LXF23420
         LA    R7,L'MAPNEW         Keyword length                       LXF23430
         LA    R3,VOLSER           New volser address                   LXF23440
         J     SHOWMAP                                                  LXF23450
SHOWMAP  DS    0H                                                       LXF23460
         ST    R14,SAVEWRK1        Save linkage register                LXF23470
         BRAS  R14,SMAPHDR         Write the header                     LXF23480
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF23490
         JE    SMAPFBA             Yes, show map for FBA disk           LXF23500
         LA    R4,F1BF1KY          First format 1 DSCB                  LXF23510
         USING F1DSCB,R4                                                LXF23520
         LHI   R0,1                One track for label                  LXF23530
         LHI   R2,0                Start on track zero                  LXF23540
         LR    R3,R2               End on track zero                    LXF23550
         LHI   R5,0                Multiple sizes                       LXF23560
         LA    R7,KLABTRK          Label keyword                        LXF23570
         LA    R8,L'KLABTRK        Length                               LXF23580
         BRAS  R14,SMAPMSG         Show label extent                    LXF23590
         LR    R2,R0               VTOC on track one                    LXF23600
         LR    R3,R2               End on track zero                    LXF23610
         LHI   R5,96               96 byte records                      LXF23620
         LA    R7,KVTOCTRK         VTOC keyword                         LXF23630
         LA    R8,L'KVTOCTRK       Length                               LXF23640
         BRAS  R14,SMAPMSG         Show VTOC extent                     LXF23650
SMAP2    DS    0H                                                       LXF23660
         CLI   DS1FMTID,C'1'       Active DSCB?                         LXF23670
         JNE   SMAPFREE            No, Show free space                  LXF23680
         SPACE 1                                                        LXF23690
         ICM   R5,3,DS1BLKL        Block size                           LXF23700
         LHI   R0,0                Clear for insert                     LXF23710
         LR    R2,R0               Clear for insert                     LXF23720
         LR    R3,R0               Clear for insert                     LXF23730
         ICM   R2,3,DS1EXT1+2      Starting cylinder                    LXF23740
         MH    R2,DTRCY+2          Tracks                               LXF23750
         ICM   R0,3,DS1EXT1+4      Starting head                        LXF23760
         AR    R2,R0               First track                          LXF23770
         ICM   R3,3,DS1EXT1+6      Ending cylinder                      LXF23780
         MH    R3,DTRCY+2          Tracks                               LXF23790
         ICM   R0,3,DS1EXT1+8      Ending head                          LXF23800
         AR    R3,R0               Last track                           LXF23810
         LR    R0,R3               Last track                           LXF23820
         AHI   R0,1                Plus 1 for count                     LXF23830
         SR    R0,R2               Allocated tracks                     LXF23840
         LR    R7,R4               Dsname address                       LXF23850
         LHI   R8,44               DSN length                           LXF23860
         BRAS  R14,SMAPMSG                                              LXF23870
         LA    R4,148(,R4)         Next F1 DSCB buffer                  LXF23880
         J     SMAP2               Check next                           LXF23890
*                                                                       LXF23900
*        Show FBA format                                                LXF23910
*                                                                       LXF23920
SMAPFBA  DS    0H                                                       LXF23930
         LA    R4,FBAVTOC1         First format 1 DSCB                  LXF23940
         AHI   R4,280              Offset to format 1 DSCB              LXF23950
         USING F1DSCB,R4                                                LXF23960
         LHI   R0,1                1 block for IPL                      LXF23970
         LHI   R2,0                Start on block zero                  LXF23980
         LR    R3,R2               End on block zero                    LXF23990
         LHI   R5,512              all block 512                        LXF24000
         LA    R7,KFIPL            Label keyword                        LXF24010
         LA    R8,L'KFIPL          Length                               LXF24020
         BRAS  R14,SMAPMSG         Show IPL extent                      LXF24030
         LR    R2,R0               Label in block one                   LXF24040
         LR    R3,R2               End in block one                     LXF24050
         LA    R7,KFLBL            Label keyword                        LXF24060
         LA    R8,L'KFLBL          Length                               LXF24070
         BRAS  R14,SMAPMSG         Show VTOC extent                     LXF24080
         LHI   R0,2                2 blocks for VTOC                    LXF24090
         LHI   R2,2                VTOC in block two                    LXF24100
         LHI   R3,3                End in block three                   LXF24110
         LA    R7,KFVTOC           VTOC keyword                         LXF24120
         LA    R8,L'KFVTOC         Length                               LXF24130
         BRAS  R14,SMAPMSG         Show VTOC extent                     LXF24140
SFMAP2   DS    0H                                                       LXF24150
         CLI   DS1FMTID,C'1'       Active DSCB?                         LXF24160
         JNE   SMAPEXIT            No, return                           LXF24170
         ICM   R5,3,DS1BLKL        Block size                           LXF24180
         LHI   R0,0                Clear for insert                     LXF24190
         LR    R2,R0               Clear for insert                     LXF24200
         LR    R3,R0               Clear for insert                     LXF24210
         ICM   R2,15,DS1EXT1+2     Starting block                       LXF24220
         ICM   R3,15,DS1EXT1+6     Ending block                         LXF24230
         LHI   R14,0               Clear for divide                     LXF24240
         LR    R15,R5              Current block size                   LXF24250
         D     R14,F512            FBA block per data block             LXF24260
         LR    R0,R15              Save in R0                           LXF24270
         LR    R15,R3              Last block                           LXF24280
         AHI   R15,1               Plus 1 for count                     LXF24290
         SR    R15,R2              Allocated blocks                     LXF24300
         LHI   R14,0               Clear for divide                     LXF24310
         DR    R14,R0              Blocks of block size                 LXF24320
         LR    R0,R15              Set blocks                           LXF24330
         LR    R7,R4               Dsname address                       LXF24340
         LHI   R8,44               DSN length                           LXF24350
         BRAS  R14,SMAPMSG                                              LXF24360
         J     SMAPEXIT            Only one of FBA                      LXF24370
         DROP  R4                                                       LXF24380
*        --------                                                       LXF24390
*                                                                       LXF24400
*        Show free space                                                LXF24410
*                                                                       LXF24420
SMAPFREE DS    0H                                                       LXF24430
         LHI   R5,0                Block size 0 for free space          LXF24440
         TM    FLAG3,NEEDF7        Have an F7 DSCB?                     LXF24450
         JO    SMAPF7              Yes, process F7                      LXF24460
         USING F5DSCB,R4                                                LXF24470
*        ---------------                                                LXF24480
         LA    R4,F5BF1KY          Format 5 DSCB                        LXF24490
         LA    R1,DS5AVEXT         First extent                         LXF24500
SMAPF5LP DS    0H                                                       LXF24510
         CLC   0(5,R1),ZERO        Any free space?                      LXF24520
         JE    SMAPEXIT            No, return to caller                 LXF24530
         SPACE 1                                                        LXF24540
         LHI   R0,0                Clear for insert                     LXF24550
         LR    R2,R0               Clear for insert                     LXF24560
         LR    R3,R0               Clear for insert                     LXF24570
         ICM   R2,3,0(R1)          Starting track                       LXF24580
         ICM   R0,3,2(R1)          Full cylinders                       LXF24590
         MH    R0,DTRCY+2          Tracks                               LXF24600
         IC    R3,4(,R1)           Additionl tracks                     LXF24610
         AR    R0,R3               Total tracks available               LXF24620
         LR    R3,R2               Starting track                       LXF24630
         AR    R3,R0               Ending track + 1                     LXF24640
         BCTR  R3,*-*              Ending track                         LXF24650
         LA    R7,KFREE            Free keyword                         LXF24660
         LA    R8,L'KFREE          Length                               LXF24670
         ST    R1,SAVEWRK2         Save pointer                         LXF24680
         BRAS  R14,SMAPMSG                                              LXF24690
         L     R1,SAVEWRK2                                              LXF24700
         LA    R1,5(,R1)           Next extent                          LXF24710
         J     SMAPF5LP            Check next                           LXF24720
         DROP  R4                                                       LXF24730
*        --------                                                       LXF24740
         SPACE 2                                                        LXF24750
SMAPF7   DS    0H                                                       LXF24760
         USING F7DSCB,R4                                                LXF24770
*        ---------------                                                LXF24780
         LA    R4,F7BF1KY          Format 5 DSCB                        LXF24790
         LA    R1,DS7AVEXT         First extent                         LXF24800
SMAPF7LP DS    0H                                                       LXF24810
         CLC   0(5,R1),ZERO        Any free space?                      LXF24820
         JE    SMAPEXIT            No, return to caller                 LXF24830
         SPACE 1                                                        LXF24840
         LHI   R0,0                Clear for insert                     LXF24850
         LR    R2,R0               Clear for insert                     LXF24860
         LR    R3,R0               Clear for insert                     LXF24870
         ICM   R2,15,0(R1)         Starting track                       LXF24880
         ICM   R0,15,4(R1)         Tracks                               LXF24890
         LR    R3,R2               Starting track                       LXF24900
         AR    R3,R0               Ending track + 1                     LXF24910
         BCTR  R3,*-*              Ending track                         LXF24920
         LA    R7,KFREE            Free keyword                         LXF24930
         LA    R8,L'KFREE          Length                               LXF24940
         ST    R1,SAVEWRK2         Save pointer                         LXF24950
         BRAS  R14,SMAPMSG                                              LXF24960
         L     R1,SAVEWRK2                                              LXF24970
         LA    R1,8(,R1)           Next extent                          LXF24980
         J     SMAPF7LP            Check next                           LXF24990
         DROP  R4                                                       LXF25000
*        --------                                                       LXF25010
         SPACE 1                                                        LXF25020
SMAPEXIT DS    0H                                                       LXF25030
         LA    R5,SGIOPLST         Diag A8 plist address                LXF25040
         L     R14,SAVEWRK1        Restore return register              LXF25050
         BR    R14                 Return                               LXF25060
         SPACE 1                                                        LXF25070
SMAPHDR  DS    0H                                                       LXF25080
         LHI   R0,0                                                     LXF25090
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF25100
         SPACE 1                                                        LXF25110
         LXMSG TEXTA=LXMSG05,                                          -LXF25120
               SUB=(CHARA,((R2),(R7)),DEV,(R0),CHARA,((R3),6))          LXF25130
         SPACE 1                                                        LXF25140
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF25150
         JNE   SMAPCKD             No... Skip                           LXF25160
         SPACE 1                                                        LXF25170
         LXMSG TEXTA=LXMSG07,COMP=NO                                    LXF25180
         J     SMAPXIT                                                  LXF25190
         SPACE 1                                                        LXF25200
SMAPCKD  DS    0H                                                       LXF25210
         LXMSG TEXTA=LXMSG06,COMP=NO                                    LXF25220
         SPACE 1                                                        LXF25230
SMAPXIT  DS    0H                                                       LXF25240
         BR    R14                 Return                               LXF25250
         SPACE 1                                                        LXF25260
SMAPMSG  DS    0H                                                       LXF25270
         LXMSG TEXTA=LXMSG08,COMP=NO,                                  -LXF25280
               SUB=(DEC,((R2),11),DEC,((R3),11),DEC,((R0),11),         -LXF25290
               DEC,((R5),4),CHARA,((R7),(R8)))                          LXF25300
         SPACE 1                                                        LXF25310
         BR    R14                                                      LXF25320
         SPACE 1                                                        LXF25330
*======================== End of Mainline ===================*          LXF25340
         EJECT                                                          LXF25350
*                                                                       LXF25360
SETRETCD DS    0H                                                       LXF25370
         STH   R15,RETCODE         Set return code                      LXF25380
*        J     EXIT                Exit                                 LXF25390
         SPACE 1                                                        LXF25400
EXIT     DS    0H                                                       LXF25410
         LR    R2,R13              Our savearea in R1                   LXF25420
         LH    R15,RETCODE         Save return code                     LXF25430
         L     R13,4(,R13)         Caller's save area in R13            LXF25440
         ST    R15,SAVER15         Set in caller's savearea             LXF25450
         LH    R0,=Y(FMTWRKLN)     Work area length                     LXF25460
         SPACE 1                                                        LXF25470
         CMSSTOR RELEASE,          Free save area storage              -LXF25480
               BYTES=(R0),                                             -LXF25490
               ADDR=(R2)                                                LXF25500
         SPACE 1                                                        LXF25510
         LM    R14,R12,12(R13)     Restore caller's registers           LXF25520
         BR    R14                                                      LXF25530
         SPACE 1                                                        LXF25540
*====================== End of Mainline =====================*          LXF25550
         EJECT                                                          LXF25560
*============================================================*          LXF25570
*                                                            *          LXF25580
* Name     - FMTIO.                                          *          LXF25590
*                                                            *          LXF25600
* Function - Subroutine to setup CCW chains and do I/O.      *          LXF25610
*                                                            *          LXF25620
* On Entry - R14 - Link register                             *          LXF25630
*            R15 - Base                                      *          LXF25640
*                                                            *          LXF25650
* On Exit  - R15 - Return code                               *          LXF25660
*            CC  - Z = Okay, NZ = Error                      *          LXF25670
*                                                            *          LXF25680
*============================================================*          LXF25690
         SPACE 1                                                        LXF25700
FMTIO    DS    0H                                                       LXF25710
         ST    R15,ECKDTIC+4       Requested to base CP                 LXF25720
         L     R15,VSLRSRC         Get extent info                      LXF25730
         ST    R15,VSDEESC         Set as start entent                  LXF25740
         ST    R15,VSDEEEC         And end extent inde plist            LXF25750
         ST    R15,VSLRSKC         Set LR seek CCHH                     LXF25760
         LA    R15,ECKDCP          Set base CPA                         LXF25770
FMTIO4   DS    0H                                                       LXF25780
         ST    R15,SGICPA          ....                                 LXF25790
         DIAG  R5,R0,X'A8'         Do synchronous i/o                   LXF25800
         BR    R14                                                      LXF25810
         SPACE 1                                                        LXF25820
*======================== End of Mainline ===================*          LXF25830
         EJECT                                                          LXF25840
*============================================================*          LXF25850
*                                                            *          LXF25860
* Name     - NXTPARM.                                        *          LXF25870
*                                                            *          LXF25880
* Function - Check for next parameter.                       *          LXF25890
*                                                            *          LXF25900
* On Entry - R14 - Link register                             *          LXF25910
*                                                            *          LXF25920
* On Exit  - CC  - Z = Parameter found, NZ = Missing parm    *          LXF25930
*                                                            *          LXF25940
*============================================================*          LXF25950
         SPACE 1                                                        LXF25960
NXTPARM  DS    0H                                                       LXF25970
         LA    R8,8(,R8)           Incr plist pointer                   LXF25980
         CLI   0(R8),X'FF'         Fence ?                              LXF25990
         JE    NOSUBPRM            Yes, missing parameter               LXF26000
         SPACE 1                                                        LXF26010
         BR    R14                 Return                               LXF26020
         SPACE 1                                                        LXF26030
*======================== End of Mainline ===================*          LXF26040
         EJECT                                                          LXF26050
*============================================================*          LXF26060
*                                                            *          LXF26070
* Name     - VSCNVTHB.                                       *          LXF26080
*                                                            *          LXF26090
* Function - Convert EBCDIC hex to binary.                   *          LXF26100
*                                                            *          LXF26110
* On Entry - R14 - Link register                             *          LXF26120
*            R1  - Field                                     *          LXF26130
*                                                            *          LXF26140
* On Exit  - R1  - Converted value                           *          LXF26150
*                                                            *          LXF26160
*============================================================*          LXF26170
         SPACE 1                                                        LXF26180
VSCNVTHB DS    0H                                                       LXF26190
         STM   R0,R3,SAVEWRK0      Save registers                       LXF26200
         LR    R3,R1               Save field length                    LXF26210
         LHI   R2,0                Clear reg                            LXF26220
         LR    R1,R2               ....                                 LXF26230
LOOP1    EQU   *                                                        LXF26240
         IC    R2,0(,R3)           Get digit                            LXF26250
         CLI   0(R3),C' '          End of data ?                        LXF26260
         JE    ERR2                Br if yes                            LXF26270
         CLI   0(R3),C'0'          Greater than zero?                   LXF26280
         JL    LOOP3               No, try a-f                          LXF26290
         CLI   0(R3),C'9'          Greater than nine?                   LXF26300
         JH    ERR2B               Yes, error                           LXF26310
         SPACE 1                                                        LXF26320
         AHI   R2,-240             Make digit a hex number              LXF26330
         J     LOOP2               Continue                             LXF26340
         SPACE 1                                                        LXF26350
LOOP3    EQU   *                                                        LXF26360
         CLI   0(R3),C'A'          Less than "A"?                       LXF26370
         JL    ERR2B               Yes  error                           LXF26380
         SPACE 1                                                        LXF26390
         CLI   0(R3),C'F'          Greater than "F"?                    LXF26400
         JH    ERR2B               Yes  error                           LXF26410
         SPACE 1                                                        LXF26420
         AHI   R2,-183             Make char a hex number               LXF26430
         SPACE 1                                                        LXF26440
LOOP2    EQU   *                                                        LXF26450
         SLL   R1,4                Assemble next digit                  LXF26460
         AR    R1,R2               ....                                 LXF26470
         LA    R3,1(,R3)           Bump ptr                             LXF26480
         BRCT  R0,LOOP1            Loop through entire field            LXF26490
         SPACE 1                                                        LXF26500
         L     R0,SAVEWRK0         Set bytes processed                  LXF26510
         SPACE 1                                                        LXF26520
HBEXIT   DS    0H                                                       LXF26530
         LM    R2,R3,SAVEWRK2      Restore work registers               LXF26540
         C     R0,SAVEWRK0         Set cc                               LXF26550
         BR    R14                 Return                               LXF26560
         SPACE 1                                                        LXF26570
*======================== End of Mainline ===================*          LXF26580
         EJECT                                                          LXF26590
*============================================================*          LXF26600
*                                                            *          LXF26610
* Name     - ERR2.                                           *          LXF26620
*                                                            *          LXF26630
* Function - Perform error proceessing.                      *          LXF26640
*                                                            *          LXF26650
* On Entry -                                                 *          LXF26660
*                                                            *          LXF26670
* On Exit  -                                                 *          LXF26680
*                                                            *          LXF26690
*============================================================*          LXF26700
         SPACE 1                                                        LXF26710
ERR2     DS    0H                                                       LXF26720
         LR    R2,R0               SAVE RESIDUAL DATA LENGTH            LXF26730
         L     R0,SAVEWRK0         ORIGINAL LENGTH                      LXF26740
         SR    R0,R2               LENGTH OF FIELD                      LXF26750
         JNZ   HBEXIT                                                   LXF26760
         SPACE 1                                                        LXF26770
ERR2B    DS    0H                                                       LXF26780
         L     R0,X7FF             Set a high number                    LXF26790
         J     HBEXIT                                                   LXF26800
         SPACE 1                                                        LXF26810
*======================== End of Mainline ===================*          LXF26820
         EJECT                                                          LXF26830
*============================================================*          LXF26840
*                                                            *          LXF26850
* Name     - VSCNVTBH.                                       *          LXF26860
*                                                            *          LXF26870
* Function - Convert binary to EBCDIC hex.                   *          LXF26880
*                                                            *          LXF26890
* On Entry - R14 - Link register                             *          LXF26900
*            R1  - Field                                     *          LXF26910
*                                                            *          LXF26920
* On Exit  - R0/R1 - Value of converted value.               *          LXF26930
*                                                            *          LXF26940
*============================================================*          LXF26950
         SPACE 1                                                        LXF26960
VSCNVTBH DS    0H                                                       LXF26970
         ST    R1,DWORK1             STORE BINARY                       LXF26980
         UNPK  DWORK2(9),DWORK1(5)   UNPACK                             LXF26990
         TR    DWORK2(8),TRTAB-240   TRANSLATE                          LXF27000
         LM    R0,R1,DWORK2          SET R0 AND R1                      LXF27010
         BR    R14                   RETURN                             LXF27020
         SPACE 1                                                        LXF27030
*======================== End of Mainline ===================*          LXF27040
         EJECT                                                          LXF27050
*============================================================*          LXF27060
*                                                            *          LXF27070
* Name     - VSCNVTBH.                                       *          LXF27080
*                                                            *          LXF27090
* Function - Convert EBCDIC decimal to binary.               *          LXF27100
*                                                            *          LXF27110
* On Entry - R14 - Link register                             *          LXF27120
*            R1  - Field                                     *          LXF27130
*                                                            *          LXF27140
* On Exit  - R1  - Binary value                              *          LXF27150
*                                                            *          LXF27160
*============================================================*          LXF27170
         SPACE 1                                                        LXF27180
VSCNVTDB DS    0H                                                       LXF27190
         STM   R0,R2,SAVEWRK0      Save input registers                 LXF27200
         CHI   R0,10               Greater than 10 digits?              LXF27210
         JH    ERR3                                                     LXF27220
         SPACE 1                                                        LXF27230
         LHI   R2,0                For true length of field             LXF27240
         J     DECCHK2             First byte must be numeric           LXF27250
         SPACE 1                                                        LXF27260
DECCHK   DS    0H                                                       LXF27270
         CLI   0(R1),C' '          Find a blank?                        LXF27280
         JE    DECDONE             Yes, process field                   LXF27290
         SPACE 1                                                        LXF27300
         CLI   0(R1),C','          Find a comma?                        LXF27310
         JE    DECDONE             Yes, process field                   LXF27320
         SPACE 1                                                        LXF27330
DECCHK2  DS    0H                                                       LXF27340
         CLI   0(1),C'0'           Numeric value?                       LXF27350
         JL    ERR3                No, invalid character                LXF27360
         SPACE 1                                                        LXF27370
         CLI   0(1),C'9'           ....                                 LXF27380
         JH    ERR3                No, invalid character                LXF27390
         SPACE 1                                                        LXF27400
         LA    R2,1(,R2)           Increment length                     LXF27410
         LA    R1,1(,R1)           Next byte to test                    LXF27420
         BRCT  R0,DECCHK           Continue if more                     LXF27430
         SPACE 1                                                        LXF27440
DECDONE  DS    0H                                                       LXF27450
         L     R1,SAVEWRK1         Restore data address                 LXF27460
         ST    R2,SAVEWRK2         Save true length of field            LXF27470
         AHI   R2,-1               Decrement for execute                LXF27480
         EX    R2,PACK             Pack number                          LXF27490
         CP    DWORK1(8),=PL8'2147483647'  Greater than max?            LXF27500
         JH    ERR3                        Yes... Error                 LXF27510
         SPACE 1                                                        LXF27520
         CVB   R1,DWORK1           Convert to binary                    LXF27530
         SETCC 0                   Set condition code 0                 LXF27540
         SPACE 1                                                        LXF27550
ERR3     EQU   *                                                        LXF27560
         L     R0,SAVEWRK0         Restore requested length             LXF27570
         L     R2,SAVEWRK2         Return true length                   LXF27580
         BR    R14                 Return                               LXF27590
         SPACE 1                                                        LXF27600
PACK     PACK  DWORK1(8),0(0,R1)   Pack decimal data                    LXF27610
         SPACE 1                                                        LXF27620
*======================== End of Mainline ===================*          LXF27630
         EJECT                                                          LXF27640
*============================================================*          LXF27650
*                                                            *          LXF27660
* Name     - VSCGETLN.                                       *          LXF27670
*                                                            *          LXF27680
* Function - Get length of line.                             *          LXF27690
*                                                            *          LXF27700
* On Entry - R14 - Link register                             *          LXF27710
*            R0  - Maximum length                            *          LXF27720
*            R1  - Field to check                            *          LXF27730
*                                                            *          LXF27740
* On Exit  - R2  - Field length                              *          LXF27750
*                                                            *          LXF27760
*============================================================*          LXF27770
         SPACE 1                                                        LXF27780
VSCGETLN DS    0H                                                       LXF27790
         STM   R0,R1,SAVEWRK0        SAVE REGISTER                      LXF27800
         LR    R2,R0                 MAXIMUM LENGTH                     LXF27810
         SPACE 1                                                        LXF27820
GETLN2   DS    0H                                                       LXF27830
         CLI   0(R1),C' '            END OF FIELD ?                     LXF27840
         JE    GETLN4                BR IF YES                          LXF27850
         SPACE 1                                                        LXF27860
         CLI   0(R1),C','            END OF FIELD ?                     LXF27870
         JE    GETLN4                BR IF YES                          LXF27880
         SPACE 1                                                        LXF27890
         LA    R1,1(,R1)             INCR ADDRESS                       LXF27900
         BRCT  R0,GETLN2                                                LXF27910
         SPACE 1                                                        LXF27920
GETLN4   DS    0H                                                       LXF27930
         SR    R2,R0                 SET FIELD LENGTH AND CC            LXF27940
         LM    R0,R1,SAVEWRK0        RESTORE CALLERS REGS               LXF27950
         BR    R14                   RETURN                             LXF27960
         SPACE 1                                                        LXF27970
*======================== End of Mainline ===================*          LXF27980
         EJECT                                                          LXF27990
*------------------------------------------------------------*          LXF28000
*        Error Messages                                      *          LXF28010
*------------------------------------------------------------*          LXF28020
         SPACE 1                                                        LXF28030
VDEVREQ  DS    0H                                                       LXF28040
         LXMSG TEXTA=LXMSG09                                            LXF28050
         SPACE 1                                                        LXF28060
         LHI   R15,2001            Set return code                      LXF28070
         STH   R15,RETCODE         ....                                 LXF28080
         J     ERR06                                                    LXF28090
         SPACE 2                                                        LXF28100
VDEVINV  DS    0H                                                       LXF28110
         SPACE 1                                                        LXF28120
         LXMSG TEXTA=LXMSG10,SUB=(CHARA,((R8),8))                       LXF28130
         SPACE 1                                                        LXF28140
         LHI   R15,2002            Set return code                      LXF28150
         STH   R15,RETCODE         ....                                 LXF28160
         J     ERR06                                                    LXF28170
         SPACE 2                                                        LXF28180
LINKEDRO DS    0H                                                       LXF28190
         LHI   R0,0                                                     LXF28200
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF28210
         SPACE 1                                                        LXF28220
         LXMSG TEXTA=LXMSG12,SUB=(DEV,(R0))                             LXF28230
         SPACE 1                                                        LXF28240
         LHI   R15,2003            Set return code                      LXF28250
         STH   R15,RETCODE         ....                                 LXF28260
         J     ERR06                                                    LXF28270
         SPACE 2                                                        LXF28280
NOTDASD  DS    0H                                                       LXF28290
         LHI   R0,0                                                     LXF28300
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF28310
         SPACE 1                                                        LXF28320
         LXMSG TEXTA=LXMSG12,SUB=(DEV,(R0))                             LXF28330
         SPACE 1                                                        LXF28340
         LHI   R15,2004            Set return code                      LXF28350
         J     SETRETCD                                                 LXF28360
         SPACE 2                                                        LXF28370
RSTERR   DS    0H                                                       LXF28380
         LHI   R0,0                                                     LXF28390
         ICM   R0,3,VSLRSRC        Get Cylinder number                  LXF28400
         MH    R0,DBLTR+2          Track for cylinder number            LXF28410
         AH    R0,VSLRSRH          Track number                         LXF28420
         SPACE 1                                                        LXF28430
         LXMSG TEXTA=LXMSG13,SUB=(DEC,((R0),8))                         LXF28440
         LXMSG TEXTA=LXMSG56                                            LXF28450
         SPACE 1                                                        LXF28460
         LHI   R15,2005            Set return code                      LXF28470
         STH   R15,RETCODE         ....                                 LXF28480
         J     ERR06                                                    LXF28490
         SPACE 2                                                        LXF28500
RSTERR2  DS    0H                                                       LXF28510
         LHI   R0,0                                                     LXF28520
         ICM   R0,3,VSLRSRC        Get Cylinder number                  LXF28530
         MH    R0,DBLTR+2          Track for cylinder number            LXF28540
         AH    R0,VSLRSRH          Track number                         LXF28550
         SPACE 1                                                        LXF28560
         LXMSG TEXTA=LXMSG14,                                          -LXF28570
               SUB=(DEC,((R0),8))                                       LXF28580
         LXMSG TEXTA=LXMSG15                                            LXF28590
         SPACE 1                                                        LXF28600
         LHI   R15,2005            Set return code                      LXF28610
         STH   R15,RETCODE         ....                                 LXF28620
         J     ERR06                                                    LXF28630
         SPACE 2                                                        LXF28640
RSTUERR  DS    0H                                                       LXF28650
         LHI   R2,0                                                     LXF28660
         ICM   R2,3,VSLRSRC        Get CCHH                             LXF28670
         SR    R3,R3                                                    LXF28680
         IC    R3,VSLRSRR          Get RR                               LXF28690
         SPACE 1                                                        LXF28700
         LXMSG TEXTA=LXMSG16,                                          -LXF28710
               SUB=(HEX,((R2),8),HEX,((R3),2))                          LXF28720
         SPACE 1                                                        LXF28730
         LHI   R15,2006            Set return code                      LXF28740
         STH   R15,RETCODE         ....                                 LXF28750
         J     ERR06                                                    LXF28760
         SPACE 2                                                        LXF28770
UNEXPECT DS    0H                                                       LXF28780
         SPACE 1                                                        LXF28790
         LXMSG TEXTA=LXMSG17,SUB=(CHARA,((R8),8))                       LXF28800
         SPACE 1                                                        LXF28810
         LHI   R15,2007            Set return code                      LXF28820
         STH   R15,RETCODE         ....                                 LXF28830
         J     ERR06                                                    LXF28840
         SPACE 2                                                        LXF28850
INVOPTN  DS    0H                                                       LXF28860
         LXMSG TEXTA=LXMSG18,SUB=(CHARA,((R8),8))                       LXF28870
         SPACE 1                                                        LXF28880
         LHI   R15,2008            Set return code                      LXF28890
         STH   R15,RETCODE         ....                                 LXF28900
         J     ERR06                                                    LXF28910
         SPACE 2                                                        LXF28920
INVBSZ   DS    0H                                                       LXF28930
         LXMSG TEXTA=LXMSG19,SUB=(DEC,((R4),8))                         LXF28940
         SPACE 1                                                        LXF28950
         LHI   R15,2021            Set return code                      LXF28960
         STH   R15,RETCODE         ....                                 LXF28970
         J     ERR06                                                    LXF28980
         SPACE 2                                                        LXF28990
NOTCDL   DS    0H                                                       LXF29000
         LXMSG TEXTA=LXMSG20,SUB=(DEV,(R0))                             LXF29010
         SPACE 1                                                        LXF29020
         LHI   R15,2022            Set return code                      LXF29030
         STH   R15,RETCODE         ....                                 LXF29040
         J     ERR06               Exit                                 LXF29050
         SPACE 2                                                        LXF29060
PARTERR  DS    0H                                                       LXF29070
         LHI   R2,0                Clear for insert                     LXF29080
         ICM   R2,3,0(R3)          Cylinder start                       LXF29090
         MH    R2,DTRCY+2          in tracks                            LXF29100
         AH    R2,2(,R3)           plus track number                    LXF29110
         LHI   R4,0                Clear for insert                     LXF29120
         ICM   R4,3,4(R3)          Cylinder end                         LXF29130
         MH    R4,DTRCY+2          in tracks                            LXF29140
         AH    R4,6(R3)            plus track number                    LXF29150
         SPACE 1                                                        LXF29160
         LXMSG TEXTA=LXMSG21,                                          -LXF29170
               SUB=(DEC,((R2),8),DEC,((R4),8),CHARA,((R6),24))          LXF29180
         SPACE 1                                                        LXF29190
         LHI   R15,2009            Set return code                      LXF29200
         STH   R15,RETCODE         ....                                 LXF29210
         OI    FLAG3,PARTERRS      Show we have an error                LXF29220
         BR    R14                                                      LXF29230
         SPACE 2                                                        LXF29240
PARTOVLP DS    0H                                                       LXF29250
         AHI   R3,-8               Prior partition end                  LXF29260
         LHI   R2,0                Clear for insert                     LXF29270
         ICM   R2,3,0(R3)          Cylinder start                       LXF29280
         MH    R2,DTRCY+2          in tracks                            LXF29290
         AH    R2,2(,R3)           plus track number                    LXF29300
         LHI   R4,0                Clear for insert                     LXF29310
         ICM   R4,3,4(R3)          Cylinder end                         LXF29320
         MH    R4,DTRCY+2          in tracks                            LXF29330
         AH    R4,6(R3)            plus track number                    LXF29340
         LHI   R6,0                Clear for insert                     LXF29350
         ICM   R6,3,8(R3)          Cylinder start                       LXF29360
         MH    R6,DTRCY+2          in tracks                            LXF29370
         AH    R6,10(,R3)          plus track number                    LXF29380
         LHI   R7,0                Clear for insert                     LXF29390
         ICM   R7,3,12(R3)         Cylinder end                         LXF29400
         MH    R7,DTRCY+2          in tracks                            LXF29410
         AH    R7,14(,R3)          plus track number                    LXF29420
         SPACE 1                                                        LXF29430
         LXMSG TEXTA=LXMSG22,                                          -LXF29440
               SUB=(DEC,((R2),8),DEC,((R4),8),DEC,((R6),8),            -LXF29450
               DEC,((R7),8))                                            LXF29460
         SPACE 1                                                        LXF29470
         LHI   R15,2010            Set return code                      LXF29480
         STH   R15,RETCODE         ....                                 LXF29490
         OI    FLAG3,PARTERRS      Show we have an error                LXF29500
         AHI   R3,8                Back to partition start              LXF29510
         BR    R14                                                      LXF29520
         SPACE 2                                                        LXF29530
CFGERR   DS    0H                                                       LXF29540
         LA    R8,TERMBUF          Config file buffer                   LXF29550
         SPACE 1                                                        LXF29560
         LXMSG TEXTA=LXMSG23,SUB=(CHARA,((R8),20))                      LXF29570
         SPACE 1                                                        LXF29580
         LHI   R15,2011            Set return code                      LXF29590
         J     SETRETCD                                                 LXF29600
         SPACE 2                                                        LXF29610
FSERROR  DS    0H                                                       LXF29620
         STH   R15,RETCODE         ....                                 LXF29630
         LR    R0,R15              FSREAD return code                   LXF29640
         SPACE 1                                                        LXF29650
         CALL  LXFSE               Issue fs error message               LXF29660
         SPACE 1                                                        LXF29670
         J     ERR06                                                    LXF29680
         SPACE 2                                                        LXF29690
UNKNLBL  DS    0H                                                       LXF29700
         LXMSG TEXTA=LXMSG24                                            LXF29710
         SPACE 1                                                        LXF29720
         LHI   R15,2012            Set return code                      LXF29730
         STH   R15,RETCODE         ....                                 LXF29740
         J     ERR06                                                    LXF29750
         SPACE 2                                                        LXF29760
INVFBA   DS    0H                                                       LXF29770
INVECKD  DS    0H                                                       LXF29780
         LA    R3,ECKDDC           ECKD constant                        LXF29790
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF29800
         JNE   INVDEVOP            No, do an ECKD format                LXF29810
         LA    R3,FBADC            FBA constant                         LXF29820
INVDEVOP DS    0H                                                       LXF29830
         LXMSG TEXTA=LXMSG25,                                          -LXF29840
               SUB=(CHARA,((R8),8),CHARA,((R3),4))                      LXF29850
         SPACE 1                                                        LXF29860
         LHI   R15,2014            Set return code                      LXF29870
         STH   R15,RETCODE         ....                                 LXF29880
         J     ERR06                                                    LXF29890
         SPACE 2                                                        LXF29900
NOSUBPRM DS    0H                                                       LXF29910
         AHI   R8,-8               Backup to option                     LXF29920
         SPACE 1                                                        LXF29930
         LXMSG TEXTA=LXMSG26,                                          -LXF29940
               SUB=(CHARA,((R8),8))                                     LXF29950
         SPACE 1                                                        LXF29960
         LHI   R15,2015            Set return code                      LXF29970
         STH   R15,RETCODE         ....                                 LXF29980
         J     ERR06                                                    LXF29990
         SPACE 2                                                        LXF30000
CONFLICT DS    0H                                                       LXF30010
         LXMSG TEXTA=LXMSG27,                                          -LXF30020
               SUB=(CHARA,((R8),8))                                     LXF30030
         SPACE 1                                                        LXF30040
         LHI   R15,2016            Set return code                      LXF30050
         STH   R15,RETCODE         ....                                 LXF30060
         J     ERR06                                                    LXF30070
         SPACE 2                                                        LXF30080
PMISSING DS    0H                                                       LXF30090
         LXMSG TEXTA=LXMSG28,                                          -LXF30100
               SUB=(CHARA,((R8),8))                                     LXF30110
         SPACE 1                                                        LXF30120
         LHI   R15,2017            Set return code                      LXF30130
         STH   R15,RETCODE         ....                                 LXF30140
         J     ERR06                                                    LXF30150
         SPACE 2                                                        LXF30160
DNOTATT  DS    0H                                                       LXF30170
         LHI   R0,0                                                     LXF30180
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF30190
         SPACE 1                                                        LXF30200
         LXMSG TEXTA=LXMSG29,                                          -LXF30210
               SUB=(DEV,(R0))                                           LXF30220
         SPACE 1                                                        LXF30230
         LHI   R15,2018            Set return code                      LXF30240
         J     SETRETCD                                                 LXF30250
         SPACE 2                                                        LXF30260
ERR05    DS    0H                                                       LXF30270
         LHI   R0,0                                                     LXF30280
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF30290
         SPACE 1                                                        LXF30300
         LXMSG TEXTA=LXMSG30,                                          -LXF30310
               SUB=(DEV,(R0),CHARA,(VOLSER,6))                          LXF30320
         SPACE 1                                                        LXF30330
         LHI   R15,2019            Set return code                      LXF30340
         J     SETRETCD                                                 LXF30350
         SPACE 2                                                        LXF30360
ERR06    DS    0H                                                       LXF30370
         BRAS  R7,BLANKMSG         Leave a blank line                   LXF30380
         LHI   R0,0                                                     LXF30390
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF30400
         SPACE 1                                                        LXF30410
         LXMSG TEXTA=LXMSG31,SUB=(DEV,(R0))                             LXF30420
         SPACE 1                                                        LXF30430
         OC    RETCODE,RETCODE     Return code set?                     LXF30440
         JNZ   EXIT                Yes, exit                            LXF30450
         LHI   R15,2020            Set return code                      LXF30460
         J     SETRETCD            ....                                 LXF30470
         SPACE 2                                                        LXF30480
ERR07    DS    0H                                                       LXF30490
         LHI   R0,0                                                     LXF30500
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF30510
         LR    R2,R15                                                   LXF30520
         SPACE 1                                                        LXF30530
         LXMSG TEXTA=LXMSG32,                                          -LXF30540
               SUB=(DEV,(R0),HEX4A,(VSLRSRC,5),HEX,((R2),2),           -LXF30550
               HEXA,SGICPA)                                             LXF30560
         SPACE 1                                                        LXF30570
ERR07B   DS    0H                                                       LXF30580
         LXMSG TEXTA=LXMSG33,                                          -LXF30590
               SUB=(HEXA,SGICCWA,HEXA,SGIDEVST,HEXA,SGISDATA)           LXF30600
         SPACE 1                                                        LXF30610
         LHI   R15,2000            Set return code                      LXF30620
         J     SETRETCD                                                 LXF30630
         SPACE 2                                                        LXF30640
ERR07FBA DS    0H                                                       LXF30650
         LHI   R0,0                                                     LXF30660
         ICM   R0,3,SGIDEVNO       Get VDEV number                      LXF30670
         LR    R2,R15                                                   LXF30680
         SPACE 1                                                        LXF30690
         LXMSG TEXTA=LXMSG44,                                          -LXF30700
               SUB=(DEV,(R0),HEX4A,(VSLFFDE,4),HEX,((R2),2),           -LXF30710
               HEXA,SGICPA)                                             LXF30720
         SPACE 1                                                        LXF30730
         J     ERR07B              Second half of message               LXF30740
         SPACE 2                                                        LXF30750
USRERR   DS    0H                                                       LXF30760
         APPLMSG NUM=2100,FMT=1,APPLID=VSS,TYPCALL=SVC,                -LXF30770
               SUB=(DICT,7002),MF=(E,ERRMSG)                            LXF30780
         J     SETRETCD                                                 LXF30790
         SPACE 2                                                        LXF30800
*------------------------------------------------------------*          LXF30810
*        Information and Status Messages                     *          LXF30820
*------------------------------------------------------------*          LXF30830
         SPACE 1                                                        LXF30840
VERFMT   DS    0H                                                       LXF30850
         LHI   R0,0                                                     LXF30860
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF30870
         TM    FLAG1,FFLG          Formatting disk?                     LXF30880
         JO    VERFMT2             Yes, issue format message            LXF30890
         SPACE 1                                                        LXF30900
         LXMSG TEXTA=LXMSG45,                                          -LXF30910
               SUB=(DEV,(R0))                                           LXF30920
         J     VERFMT4             Ask permission                       LXF30930
         SPACE 1                                                        LXF30940
VERFMT2  DS    0H                                                       LXF30950
         MVC   TERMBUF(4),BLANKS   Clear response area                  LXF30960
         SPACE 1                                                        LXF30970
         LXMSG TEXTA=LXMSG46,                                          -LXF30980
               SUB=(DEV,(R0))                                           LXF30990
         SPACE 1                                                        LXF31000
VERFMT4  DS    0H                                                       LXF31010
         TM    FLAG1,YFLG          Bypass verify?                       LXF31020
         BOR   R7                  Yes, just return                     LXF31030
         SPACE 1                                                        LXF31040
         LXMSG TEXTA=LXMSG47                                            LXF31050
         LXMSG TEXTA=LXMSG48                                            LXF31060
         SPACE 1                                                        LXF31070
         LA    R2,TERMBUF          Terminal read buffer                 LXF31080
         LINERD DATA=((R2),4)      Read response                       -LXF31090
               WAIT=YES,                                               -LXF31100
               MF=(E,LINERD)                                            LXF31110
         CLC   TERMBUF(4),RESP1    OK to format?                        LXF31120
         BER   R7                  Yes, Return to format                LXF31130
         SPACE 1                                                        LXF31140
         CLC   TERMBUF(4),RESPYES  OK to format?                        LXF31150
         BER   R7                  Yes, Return to format                LXF31160
         SPACE 1                                                        LXF31170
         CLC   TERMBUF(4),RESP0    OK to format?                        LXF31180
         JE    ERR06               No, exit                             LXF31190
         SPACE 1                                                        LXF31200
         CLC   TERMBUF(4),RESPNO   OK to format?                        LXF31210
         JE    ERR06               No, exit                             LXF31220
         SPACE 1                                                        LXF31230
         J     VERFMT              None valid ask again                 LXF31240
         SPACE 2                                                        LXF31250
NOTIFY   DS    0H                                                       LXF31260
         LHI   R0,0                                                     LXF31270
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF31280
         SPACE 1                                                        LXF31290
         LXMSG TEXTA=LXMSG49,                                          -LXF31300
               SUB=(DEV,(R0),CHARA,(VOLSER,6))                          LXF31310
         BR    R7                  RETURN                               LXF31320
         SPACE 2                                                        LXF31330
BLANKMSG DS    0H                                                       LXF31340
         APPLMSG TYPCALL=SVC,MF=(E,ERRMSG),TEXT=' '                     LXF31350
         BR    R7                  Return                               LXF31360
         SPACE 2                                                        LXF31370
SAYDONE  DS    0H                                                       LXF31380
         L     R3,DTOTBK           Total blocks formatted               LXF31390
         BRAS  R14,SAYBLKS         Give formatted message               LXF31400
         SPACE 1                                                        LXF31410
         LXMSG TEXTA=LXMSG50                                            LXF31420
         SPACE 1                                                        LXF31430
         J     EXIT                                                     LXF31440
         SPACE 2                                                        LXF31450
SAYBLKS  DS    0H                                                       LXF31460
         CLI   VRDCVCLA,CLASFBA    FBA dasd?                            LXF31470
         JNE   SAYBLKS2            No, do ECKD format                   LXF31480
         LHI   R0,0                Clear for divide                     LXF31490
         LR    R1,R3               Data blocks formatted                LXF31500
         MHI   R1,100              For percent                          LXF31510
         D     R0,MXFBADBK         Percent complete                     LXF31520
         J     SAYBLKS4                                                 LXF31530
         SPACE 1                                                        LXF31540
SAYBLKS2 DS    0H                                                       LXF31550
         LHI   R0,0                                                     LXF31560
         L     R1,DFMTCY           Current number formated              LXF31570
         MHI   R1,100                                                   LXF31580
         D     R0,DRDCB            Total usable cylinders               LXF31590
SAYBLKS4 DS    0H                                                       LXF31600
         LR    R2,R1               Display register                     LXF31610
         LHI   R0,0                                                     LXF31620
         ICM   R0,3,VDEVNUM        Get VDEV number                      LXF31630
         TM    FLAG1,FFLG          Formatting?                          LXF31640
         JNO   SAYBLKS6            No, Message 2                        LXF31650
         LXMSG TEXTA=LXMSG51,                                          -LXF31660
               SUB=(DEC,((R3),8),CHARA,(VOLSER,6),DEV,(R0),            -LXF31670
               DEC,((R2),3))                                            LXF31680
         SPACE 1                                                        LXF31690
         BR    R14                 Return                               LXF31700
         SPACE 1                                                        LXF31710
SAYBLKS6 DS    0H                                                       LXF31720
         LXMSG TEXTA=LXMSG52,                                          -LXF31730
               SUB=(DEC,((R3),8),CHARA,(VOLSER,6),DEV,(R0),            -LXF31740
               DEC,((R2),3))                                            LXF31750
         SPACE 1                                                        LXF31760
         BR    R14                 Return                               LXF31770
*===================== End of Error Reporting ===============*          LXF31780
         EJECT                                                          LXF31790
*------------------------------------------------------------*          LXF31800
*                    L i t e r a l s . . .                   *          LXF31810
*------------------------------------------------------------*          LXF31820
DATAAREA DS    0D                                                       LXF31830
         LTORG ,                                                        LXF31840
         SPACE 1                                                        LXF31850
*====================== End of Literals =====================*          LXF31860
         EJECT                                                          LXF31870
*------------------------------------------------------------*          LXF31880
*                    V a r i a b l e s . . .                 *          LXF31890
*------------------------------------------------------------*          LXF31900
         SPACE 1                                                        LXF31910
         SPACE 1                                                        LXF31920
*====================== End of Variables ====================*          LXF31930
         EJECT                                                          LXF31940
*------------------------------------------------------------*          LXF31950
*                    C o n s t a n t s . . .                 *          LXF31960
*------------------------------------------------------------*          LXF31970
         SPACE 1                                                        LXF31980
*                                                                       LXF31990
*        CCWS for FBA format                                            LXF32000
*                                                                       LXF32010
FBAFCCWS DS    0D                                                       LXF32020
         CCW1  X'63',VSDFXTN,CC+SILI,16                                 LXF32030
         CCW1  X'43',VSLFREC,CC+SILI,8                                  LXF32040
         CCW1  X'41',ZERO,SILI,1                                        LXF32050
*                                                                       LXF32060
*        FBA CCWS to read and write data                                LXF32070
*                                                                       LXF32080
FBADATA  DS    0D                                                       LXF32090
         CCW1  X'63',VSDFXTN,CC,16                                      LXF32100
         CCW1  X'43',VSLFREC,CC,8                                       LXF32110
FBADCCW  CCW1  X'00',0,SILI,0                                           LXF32120
*                                                                       LXF32130
*        BASE CCWS FOR ECKD RPS DEVICES                                 LXF32140
*                                                                       LXF32150
ECKDCP   DS    0D                                                       LXF32160
         CCW1  X'63',VSDEXTN,CC,16                                      LXF32170
         CCW1  X'47',VSLREC,CC,16                                       LXF32180
ECKDTIC  CCW1  X'08',0,0,0                                              LXF32190
*                                                                       LXF32200
*        CCWS to write track zero                                       LXF32210
*                                                                       LXF32220
TRK0CCWS DS    0D                                                       LXF32230
TRK0W1   CCW1  X'1D',IPL1PAT,CC+SILI,IPL1PLN                            LXF32240
TRK0W2   CCW1  X'1D',IPL2PAT,CC+SILI,IPL2PLN                            LXF32250
TRK0W3   CCW1  X'1D',VOL1LAB,CC+SILI,VOL1LN                             LXF32260
TRK0TIC  CCW1  X'08',0,0,0         TIC to continue trk 0                LXF32270
*                                                                       LXF32280
*        CCWS to read track zero                                        LXF32290
*                                                                       LXF32300
TRK0READ DS    0D                                                       LXF32310
TRK0R1   CCW1  X'1E',0,CC+SILI,8+4+24                                   LXF32320
TRK0R2   CCW1  X'1E',0,CC+SILI,8+4+144                                  LXF32330
TRK0R3   CCW1  X'1E',0,CC+SILI,8+4+80                                   LXF32340
         CCW1  X'03',*,0,0         Nop                                  LXF32350
         SPACE 1                                                        LXF32360
*                                                                       LXF32370
*        CCWs to verify a restart cylinder number                       LXF32380
*                                                                       LXF32390
RSTCCWS  DS    0D                                                       LXF32400
RSTCCW   CCW1  X'1E',0,SILI,8      Read last CYL count fld              LXF32410
*                                                                       LXF32420
*        CCW to write a DSCB                                            LXF32430
*                                                                       LXF32440
DSCBWRT  DS    0D                                                       LXF32450
         CCW1  X'8D',0,CC,44+96                                         LXF32460
         CCW1  X'03',*,0,0                                              LXF32470
*                                                                       LXF32480
*        CCW to Read DSCB's                                             LXF32490
*                                                                       LXF32500
DSCBREAD DS    0D                                                       LXF32510
         CCW1  X'1E',0,CC,8+44+96                                       LXF32520
         CCW1  X'03',*,0,0                                              LXF32530
         SPACE 1                                                        LXF32540
*                                                                       LXF32550
*        CCWS TO WRITE INITIAL INDEX AND DIRECTORY BLOCKS               LXF32560
*                                                                       LXF32570
BLOKCCW  CCW1  X'85',0,00,1                                             LXF32580
         SPACE 1                                                        LXF32590
*------------------------------------------------------------*          LXF32600
*        Track Zero Records                                  *          LXF32610
*------------------------------------------------------------*          LXF32620
TRK0RECS DS    0D                                                       LXF32630
         SPACE 1                                                        LXF32640
IPL1PAT  DS    0D                                                       LXF32650
IPL1PC   DC    F'0',AL1(1),AL1(4),AL2(24)                               LXF32660
IPL1PK   DC    C'IPL1'                                                  LXF32670
IPL1PD   DC    X'000A00000000000F'                                      LXF32680
         DC    X'0300000000000001'                                      LXF32690
         DC    X'0000000000000000'                                      LXF32700
IPL1PLN  EQU   *-IPL1PAT                                                LXF32710
         SPACE 1                                                        LXF32720
IPL2PAT  DS    0D                                                       LXF32730
IPL2PC   DC    F'0',AL1(2),AL1(4),AL2(144)                              LXF32740
IPL2PK   DC    C'IPL2'                                                  LXF32750
         DC    X'07',X'003AB8',X'40',X'000006'                          LXF32760
         DC    X'31',X'003ABE',X'40',X'000005'                          LXF32770
         DC    X'08',X'003AA0',X'00',X'000000'                          LXF32780
         DC    X'06',X'000000',X'20',X'000000'                          LXF32790
IPL2PLN  EQU   *-IPL2PAT                                                LXF32800
         EJECT                                                          LXF32810
VOL1LAB  DS    0D                                                       LXF32820
         DC    F'0',AL1(3),AL1(4),AL2(80)   Count                       LXF32830
VOL1KEY  DC    C'VOL1'                      Key                         LXF32840
VOL1DAT  DC    C'VOL1'                      Data                        LXF32850
VOLSER   DC    C'0XV111'           Volume serial                        LXF32860
VOLSEC   DC    C'0'                Security byte                        LXF32870
VTOCCC   DC    X'0000'             VTOC cylinder                        LXF32880
VTOCHH   DC    X'0001'             VTOC head                            LXF32890
VTOCRR   DC    X'01'               VTOC record                          LXF32900
         DC    CL5' '              Reserved                             LXF32910
VOLCISZ  DC    CL4' '              FBA CI-size                          LXF32920
VOLCIBC  DC    CL4' '              FBA blks/CI                          LXF32930
VOLLBCI  DC    CL4' '              FBA Labels/CI                        LXF32940
         DC    CL4' '              Reserved                             LXF32950
VOLOWNER DC    CL14'LXFMT'         Owner                                LXF32960
         DC    CL29' '             Reserved                             LXF32970
VOL1LN   EQU   *-VOL1LAB                                                LXF32980
         EJECT                                                          LXF32990
*                                                                       LXF33000
*        Start of ECKD define extent plist definition                   LXF33010
*                                                                       LXF33020
VSDEXTN  DS    0D                  DEFINE EXTENT PLIST                  LXF33030
VSDEFM   DC    X'00'               FILE MASK                            LXF33040
VSDEGA   DC    X'C0'               GLOBAL ATTRIBUTES                    LXF33050
VSDEBLK  DC    H'4104'             MAXIMUM BYTES IN BLOCK               LXF33060
VSDER45  DC    H'0'                MUST BE ZERO                         LXF33070
VSDER67  DC    H'0'                MUST BE ZERO                         LXF33080
VSDEESC  DC    H'0'                EXTENT START CYLINDER                LXF33090
VSDEESH  DC    H'0'                EXTENT START HEAD                    LXF33100
VSDEEEC  DC    H'0'                EXTENT END CYLINDER                  LXF33110
VSDEEEH  DC    H'0'                EXTENT END HEAD                      LXF33120
*                                                                       LXF33130
* ECKD Define Extent File mask definitions                              LXF33140
*                                                                       LXF33150
VSDENORM EQU   X'00'               Allow all writes except              LXF33160
*                                  HA and R0                            LXF33170
VSDEWINH EQU   X'40'               Inhibit all writes                   LXF33180
VSDEWUPO EQU   X'80'               Allow update writes only             LXF33190
VSDEWALL EQU   X'C0'               Allow all writes                     LXF33200
*                                                                       LXF33210
*        Start of FBA define extent plist definition                    LXF33220
*                                                                       LXF33230
VSDFXTN  DS    0D                  FBA define extent plist              LXF33240
VSDFMASK DC    X'00'               Mask byte                            LXF33250
VSDFRES  DC    X'00'               Reserved most be zero                LXF33260
VSDFBLK  DC    H'512'              Addressable block size 512           LXF33270
VSDFDOF  DC    F'0'                Device offset to extent              LXF33280
VSDFEFB  DC    F'0'                Extent first block                   LXF33290
VSDFELB  DC    F'0'                Extent last block                    LXF33300
*                                                                       LXF33310
* FBA Define Extent File mask definitions                               LXF33320
*                                                                       LXF33330
VSDFNORM EQU   X'00'               Permit Non-formatting writes         LXF33340
*                                  Inhibit formatting writes            LXF33350
VSDFWINH EQU   X'40'               Inhibit all writes                   LXF33360
VSDFWUPO EQU   X'80'               Reserved                             LXF33370
VSDFWALL EQU   X'C0'               Allow all writes                     LXF33380
*                                                                       LXF33390
*        End of FBA define extent definition                            LXF33400
*                                                                       LXF33410
         EJECT                                                          LXF33420
*                                                                       LXF33430
*        ECKD locate record plist definition                            LXF33440
*                                                                       LXF33450
VSLREC   DS    0D                  LOCATE RECORD PLIST                  LXF33460
VSLROP   DC    AL1(VSLRRD)         OPERATION BYTE                       LXF33470
VSLAUXB  DC    X'00'               AUXILIARY BYTE                       LXF33480
VSLRSVB  DC    X'00'               RESERVED MUST BE ZERO                LXF33490
VSLRRC   DC    X'01'               RECORD COUNT                         LXF33500
VSLRSKC  DC    H'0'                SEEK CYLINDER                        LXF33510
VSLRSKH  DC    H'0'                SEEK HEAD                            LXF33520
VSLRSRC  DC    H'0'                SEARCH CYLINDER                      LXF33530
VSLRSRH  DC    H'0'                SEARCH HEAD                          LXF33540
VSLRSRR  DC    X'0'                SEARCH RECORD                        LXF33550
VSLRSECT DC    X'00'               SECTOR NUMBER                        LXF33560
VSLROTL  DC    H'0'                OPTIONAL TRANSFER LENGTH             LXF33570
*                                                                       LXF33580
*        LOCATE RECORD OP CODE EQUATES                                  LXF33590
*                                                                       LXF33600
VSLRPRV  EQU   X'80'               PREVIOUS                             LXF33610
VSLRSMD  EQU   X'40'               SEARCH MODIFIER                      LXF33620
VSLRWD   EQU   X'01'               WRITE DATA                           LXF33630
VSLRFW   EQU   X'03'               FORMAT WRITE                         LXF33640
VSLRRD   EQU   X'06'               READ DATA                            LXF33650
VSLRWT   EQU   X'0B'               WRITE TRACK                          LXF33660
*                                                                       LXF33670
*        LOCATE RECORD AUXILIARY BYTE EQUATES                           LXF33680
*                                                                       LXF33690
VSLRATL  EQU   X'80'               USE ALTERNATE TRANSFER LENGTH        LXF33700
*                                                                       LXF33710
* Start FBA locate plist definition                                     LXF33720
*                                                                       LXF33730
VSLFREC  DS    0D                  FBA locate plist                     LXF33740
VSLFOP   DC    AL1(0)              Locate operation byte                LXF33750
VSLFREP  DC    X'00'               Replication byte                     LXF33760
VSLFBCT  DC    H'0'                Block count                          LXF33770
VSLFFDE  DC    F'0'                First block in data extent           LXF33780
*                                                                       LXF33790
VSLFREC2 DS    0D                  FBA locate plist                     LXF33800
VSLFOP2  DC    AL1(0)              Locate operation byte                LXF33810
VSLFREP2 DC    X'00'               Replication byte                     LXF33820
VSLFBCT2 DC    H'0'                Block count                          LXF33830
VSLFFDE2 DC    F'0'                First block in data extent           LXF33840
*                                                                       LXF33850
         EJECT                                                          LXF33860
MSGECB   DC    F'0'                Progress message ECB                 LXF33870
FBMAXCLR DC    F'1440'                                                  LXF33880
X7FF     DC    X'7FFFFFFF'                                              LXF33890
F1       DC    F'1'                Constant number                      LXF33900
F2       DC    F'2'                Constant number                      LXF33910
F250     DC    F'250'              CYL for 45000 blocks                 LXF33920
F512     DC    F'512'              Constant number                      LXF33930
F65536   DC    F'65536'            Max tracks before F7 DSCB            LXF33940
F360000  DC    F'360000'           FBA blks for 45000 VSSI blks         LXF33950
H0       EQU   F1,2                                                     LXF33960
H1       EQU   F1+2,2                                                   LXF33970
         SPACE 1                                                        LXF33980
RETCODE  DC    H'0'                Return code                          LXF33990
RESPYES  DC    CL4'YES '                                                LXF34000
RESPNO   DC    CL4'NO  '                                                LXF34010
RESP1    DC    CL4'1   '                                                LXF34020
RESP0    DC    CL4'0   '                                                LXF34030
MDRO     EQU   X'80'                                                    LXF34040
BASESECT DC    X'00'                                                    LXF34050
ZERO     DC    XL8'00'                                                  LXF34060
TRTAB    DC    C'0123456789ABCDEF' TRANSLATE TABLE                      LXF34070
VTOCCHR  DC    X'0000000101'                                            LXF34080
MAPNEW   DC    C'New'                                                   LXF34090
MAPCUR   DC    C'Current'                                               LXF34100
FBADC    DC    CL4'FBA'                                                 LXF34110
ECKDDC   DC    CL4'ECKD'                                                LXF34120
         SPACE 1                                                        LXF34130
PEMSG1   DC    CL24'is in label / VTOC track'                           LXF34140
PEMSG2   DC    CL24'exceeds disk size'                                  LXF34150
PEMSG3   DC    CL24'start track > end track'                            LXF34160
         SPACE 1                                                        LXF34170
KFREE    DC    C'FREE SPACE'                                            LXF34180
KLABTRK  DC    C'LABEL.TRACK'                                           LXF34190
KVTOCTRK DC    C'VTOC.TRACK'                                            LXF34200
KFIPL    DC    C'IPL.BLOCK'                                             LXF34210
KFLBL    DC    C'LABEL.BLOCK'                                           LXF34220
KFVTOC   DC    C'VTOC.BLOCKS'                                           LXF34230
         SPACE 1                                                        LXF34240
CON_B    DC    CL4'-B'             Block size                           LXF34250
CON_C    DC    CL4'-C'             Patition config file name            LXF34260
CON_F    DC    CL4'-F'             Format the disk                      LXF34270
CON_I    DC    CL4'-I'             Preserve IPL record(s)               LXF34280
CON_K    DC    CL4'-K'             Keep volume serial                   LXF34290
CON_M    DC    CL4'-M'             Issue periodic messages              LXF34300
CON_N    DC    CL4'-N'             No partitions                        LXF34310
CON_P1   DC    CL4'-P1'            Partition 1 info                     LXF34320
CON_P2   DC    CL4'-P2'            Partition 2 info                     LXF34330
CON_P3   DC    CL4'-P3'            Partition 3 info                     LXF34340
CON_S    DC    CL4'-S'             Show Mapping                         LXF34350
CON_TS   DC    CL4'-TS'            Partition type SWAP                  LXF34360
CON_U    DC    CL4'-U'             Use existing partition sizes         LXF34370
CON_Y    DC    CL4'-Y'             Bypass verify message                LXF34380
         SPACE 1                                                        LXF34390
*                                                                       LXF34400
*        Linux DSN for F1DSCB                                           LXF34410
*                                                                       LXF34420
LDSN     DS    0CL29                                                    LXF34430
         DC    C'LINUX.V'                                               LXF34440
LVOLSER  DC    CL6' '                                                   LXF34450
         DC    C'.PART'                                                 LXF34460
LPARTNM  DC    C'0001'                                                  LXF34470
         DC    C'.'                                                     LXF34480
LNATIVE  DC    C'NATIVE'                                                LXF34490
         SPACE 1                                                        LXF34500
         DS    0D                                                       LXF34510
CFGFILE  FSCB  'LXFMT1 LXCONFIG *',BSIZE=80,RECFM=F                     LXF34520
         SPACE 1                                                        LXF34530
*==================== End of Constants =====================*           LXF34540
         SPACE 1                                                        LXF34550
         END                                                            LXF34560